
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartMP Auth - å¼€å‘è€…æ§åˆ¶å°</title>
    <style>
        :root {
            --bg-color: #0b0d11;
            --panel-bg: #15191e;
            --border-color: #2d333b;
            --text-main: #adbac7;
            --text-bright: #cdd9e5;
            --accent: #5385ff;
            --accent-glow: rgba(83, 133, 255, 0.3);
            --success: #57ab5a;
            --warning: #c69026;
            --danger: #e5534b;
            --active-bg: #1c2128;
        }
        body {
            margin: 0; font-family: -apple-system, system-ui, sans-serif;
            background: var(--bg-color); color: var(--text-main); line-height: 1.5;
        }
        .container { max-width: 1000px; margin: 40px auto; padding: 0 20px; }
        .header { display: flex; align-items: center; gap: 15px; margin-bottom: 30px; }
        .header h1 { font-size: 24px; color: var(--text-bright); margin: 0; }
        
        .tabs { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); }
        .tab { 
            padding: 10px 20px; cursor: pointer; border-radius: 6px 6px 0 0; 
            border: 1px solid transparent; margin-bottom: -1px; transition: 0.2s;
        }
        .tab:hover { color: var(--text-bright); background: var(--active-bg); }
        .tab.active { 
            background: var(--panel-bg); color: var(--accent);
            border: 1px solid var(--border-color); border-bottom-color: var(--panel-bg);
            font-weight: 600;
        }

        .section { background: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 30px; display: none; }
        .section.active { display: block; }

        .form-group { margin-bottom: 20px; }
        label { display: block; font-size: 13px; margin-bottom: 8px; color: var(--text-muted); }
        input, select { 
            width: 100%; padding: 12px; background: #010409; border: 1px solid var(--border-color);
            border-radius: 6px; color: var(--text-bright); outline: none; box-sizing: border-box;
        }
        input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
        
        .row { display: flex; gap: 15px; }
        .row > * { flex: 1; }

        button { 
            background: var(--accent); color: white; border: none; padding: 12px 24px; 
            border-radius: 6px; font-weight: 600; cursor: pointer; transition: 0.2s;
        }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        button.secondary { background: #373e47; color: var(--text-bright); }
        button.danger { background: transparent; border: 1px solid var(--danger); color: var(--danger); padding: 6px 12px; font-size: 12px; }
        button.danger:hover { background: var(--danger); color: white; }
        button.action-btn { padding: 6px 12px; font-size: 12px; margin-right: 5px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 13px; }
        th { text-align: left; padding: 12px; border-bottom: 1px solid var(--border-color); color: var(--text-bright); }
        td { padding: 12px; border-bottom: 1px solid var(--border-color); }
        tr:hover { background: rgba(255,255,255,0.02); }

        .status-pill { padding: 4px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; }
        .status-active { background: rgba(87,171,90,0.15); color: var(--success); }
        .status-revoked { background: rgba(229,83,75,0.15); color: var(--danger); }
        .status-inactive { background: rgba(198,144,38,0.15); color: var(--warning); }

        .result-panel { margin-top: 25px; padding: 20px; background: #010409; border-radius: 8px; position: relative; }
        .code-area { font-family: monospace; white-space: pre-wrap; font-size: 13px; color: var(--success); }
        
        #adminAuth { position: fixed; inset: 0; background: var(--bg-color); display: flex; justify-content: center; align-items: center; z-index: 100; }
        .login-box { width: 320px; text-align: center; }
    </style>
</head>
<body>

<div id="adminAuth">
    <div class="login-box">
        <h2 style="color: var(--text-bright)">èº«ä»½éªŒè¯</h2>
        <div class="form-group">
            <input type="password" id="globalSecret" placeholder="è¾“å…¥ç®¡ç†å‘˜å¯†é’¥" value="super-secret-admin-key-2026">
        </div>
        <button onclick="login()">è¿›å…¥æ§åˆ¶å°</button>
    </div>
</div>

<div class="container">
    <div class="header">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color:var(--accent)"><circle cx="12" cy="12" r="10"/><path d="M12 2v4"/><path d="M12 18v4"/><path d="M4.93 4.93l2.83 2.83"/><path d="M16.24 16.24l2.83 2.83"/><path d="M2 12h4"/><path d="M18 12h4"/><path d="M4.93 19.07l2.83-2.83"/><path d="M16.24 7.76l2.83-2.83"/></svg>
        <h1>SmartMP Auth Center</h1>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('generate')">ğŸ”¥ æé€Ÿç”Ÿå¡</div>
        <div class="tab" onclick="switchTab('manage')">ğŸ“Š å¡å¯†ç®¡ç†</div>
    </div>

    <!-- Tab: Generate -->
    <div id="sec-generate" class="section active">
        <div class="row">
            <div class="form-group">
                <label>äº§å“çº¿æ ‡è¯† (Product ID)</label>
                <input type="text" id="genProductId" value="smartmp" placeholder="ä¾‹å¦‚: smartmp">
            </div>
            <div class="form-group">
                <label>ç»‘å®šç”¨æˆ·å/å¤‡æ³¨</label>
                <input type="text" id="genUserName" placeholder="ä¾‹å¦‚: å®¢æˆ·å¾®ä¿¡åã€è®¢å•å·">
            </div>
        </div>
        <div class="row">
            <div class="form-group">
                <label>å•ç è®¾å¤‡é…é¢</label>
                <input type="number" id="genMaxDevices" value="2" min="1">
            </div>
            <div class="form-group">
                <label>ç”Ÿæˆæ•°é‡</label>
                <input type="number" id="genCount" value="1" min="1" max="100">
            </div>
        </div>
        <button id="btnDoGen" onclick="doGenerate()">âœ¦ ç«‹å³è‡ªåŠ¨åˆ¶å¡</button>

        <div id="genResult" class="result-panel" style="display:none">
            <div style="font-size:12px; color:var(--text-muted); margin-bottom:10px;">ç”ŸæˆæˆåŠŸï¼Œè¯·å¦¥å–„ä¿å­˜ï¼š</div>
            <div id="genOutput" class="code-area"></div>
            <button class="secondary" style="margin-top:15px; width:100%" onclick="copyGenResult()">å¤åˆ¶å…¨éƒ¨å¡å¯†</button>
        </div>
    </div>

    <!-- Tab: Manage -->
    <div id="sec-manage" class="section">
        <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:20px;">
            <div style="flex:1; max-width:300px;">
                <label>ç­›é€‰äº§å“</label>
                <input type="text" id="filterProductId" placeholder="è¾“å…¥ ID ç­›é€‰ï¼Œç•™ç©ºæŸ¥æ‰€æœ‰" oninput="loadLicenses()">
            </div>
            <button class="secondary" onclick="loadLicenses()">åˆ·æ–°åˆ—è¡¨</button>
        </div>

        <table id="licTable">
            <thead>
                <tr>
                    <th>æ¿€æ´»ç  (Key)</th>
                    <th>äº§å“ ID</th>
                    <th>ç”¨æˆ·å¤‡æ³¨</th>
                    <th>è®¾å¤‡ (ç”¨/æ€»)</th>
                    <th>çŠ¶æ€</th>
                    <th>ç®¡ç†</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
    let ADMIN_SECRET = "";

    function login() {
        const secret = document.getElementById('globalSecret').value;
        if (!secret) return;
        ADMIN_SECRET = secret;
        document.getElementById('adminAuth').style.display = 'none';
        loadLicenses();
    }

    function switchTab(tab) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('sec-' + tab).classList.add('active');
        if (tab === 'manage') loadLicenses();
    }

    async function doGenerate() {
        const btn = document.getElementById('btnDoGen');
        const productId = document.getElementById('genProductId').value;
        const userName = document.getElementById('genUserName').value;
        const count = document.getElementById('genCount').value;
        const maxDevices = document.getElementById('genMaxDevices').value;

        btn.disabled = true; btn.innerText = "å¤„ç†ä¸­...";
        
        try {
            const res = await fetch('/api/v1/auth/admin/generate', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + ADMIN_SECRET, 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    product_id: productId, 
                    user_name: userName,
                    count: parseInt(count), 
                    max_devices: parseInt(maxDevices) 
                })
            });
            const data = await res.json();
            if (data.success) {
                document.getElementById('genResult').style.display = 'block';
                document.getElementById('genOutput').innerText = data.keys.join('\n');
            } else { alert(data.msg); }
        } catch (e) { alert("ç”Ÿæˆå¤±è´¥: " + e.message); }
        finally { btn.disabled = false; btn.innerText = "âœ¦ ç«‹å³è‡ªåŠ¨åˆ¶å¡"; }
    }

    async function loadLicenses() {
        const filter = document.getElementById('filterProductId').value;
        const tbody = document.querySelector('#licTable tbody');
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center">æ­£åœ¨åŠ è½½æ•°æ®æµ...</td></tr>';

        try {
            const res = await fetch('/api/v1/auth/admin/licenses?product_id=' + filter, {
                headers: { 'Authorization': 'Bearer ' + ADMIN_SECRET }
            });
            const data = await res.json();
            tbody.innerHTML = '';
            if (!data.success) { 
                tbody.innerHTML = `<tr><td colspan="6" style="color:var(--danger)">${data.msg}</td></tr>`; 
                return; 
            }

            data.data.forEach(lic => {
                const tr = document.createElement('tr');
                const isRevoked = lic.status === 'revoked';
                const statusBtnText = isRevoked ? 'æ¢å¤' : 'åŠé”€';
                const newStatus = isRevoked ? 'active' : 'revoked';
                const userName = lic.user_name || '-';
                const editNameArg = lic.user_name || '';

                tr.innerHTML = `
                    <td style="font-family:monospace">${lic.license_key}</td>
                    <td>${lic.product_id}</td>
                    <td>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <span style="color:var(--text-bright)">${userName}</span>
                            <button class="action-btn secondary" style="padding:2px 6px; font-size:10px;" onclick="editUserName('${lic.license_key}', '${editNameArg}')">æ”¹</button>
                        </div>
                    </td>
                    <td>${lic.current_devices} / ${lic.max_devices}</td>
                    <td><span class="status-pill status-${lic.status}">${lic.status.toUpperCase()}</span></td>
                    <td>
                        <button class="action-btn secondary" onclick="toggleStatus('${lic.license_key}', '${newStatus}')">
                            ${statusBtnText}
                        </button>
                        <button class="action-btn danger" onclick="deleteLic('${lic.license_key}')">åˆ é™¤</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } catch (e) { tbody.innerHTML = '<tr><td colspan="6">ç½‘ç»œé”™è¯¯</td></tr>'; }
    }

    async function toggleStatus(key, status) {
        if (!confirm('ç¡®å®šè¦å°† [' + key + '] çš„çŠ¶æ€æ›´æ”¹ä¸º ' + status + ' å—ï¼Ÿ')) return;
        const res = await fetch('/api/v1/auth/admin/licenses/status', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + ADMIN_SECRET, 'Content-Type': 'application/json' },
            body: JSON.stringify({ license_key: key, status })
        });
        const data = await res.json();
        if (data.success) loadLicenses(); else alert(data.msg);
    }

    async function deleteLic(key) {
        if (!confirm('âš ï¸ é«˜å±æ“ä½œï¼šç¡®å®šè¦å½»åº•åˆ é™¤å¡å¯† [' + key + '] å—ï¼Ÿ\nè¿™å°†åŒæ—¶æ¸…é™¤æ‰€æœ‰å·²ç»‘å®šçš„æœºå™¨ï¼Œä¸”ä¸å¯æ¢å¤ï¼')) return;
        const res = await fetch('/api/v1/auth/admin/licenses', {
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + ADMIN_SECRET, 'Content-Type': 'application/json' },
            body: JSON.stringify({ license_key: key })
        });
        const data = await res.json();
        if (data.success) loadLicenses(); else alert(data.msg);
    }

    async function editUserName(key, currentName) {
        const newName = prompt('ä¿®æ”¹æ¿€æ´»ç  [' + key + '] çš„å¤‡æ³¨ä¿¡æ¯ï¼š', currentName);
        if (newName === null) return;
        const res = await fetch('/api/v1/auth/admin/licenses/user', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + ADMIN_SECRET, 'Content-Type': 'application/json' },
            body: JSON.stringify({ license_key: key, user_name: newName })
        });
        const data = await res.json();
        if (data.success) loadLicenses(); else alert(data.msg);
    }

    function copyGenResult() {
        navigator.clipboard.writeText(document.getElementById('genOutput').innerText);
        alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    }
</script>

</body>
</html>
  