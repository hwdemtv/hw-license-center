export const adminHtml = "<!DOCTYPE html>\n<html lang=\"zh-CN\">\n\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>äº’ä¸ºå¡å¯†ä¸­å¿ƒ - å¼€å‘è€…æ§åˆ¶å° </title>\n  <style>\n    :root {\n      --bg-color: #0d1117;\n      --panel-bg: #161b22;\n      --card-bg: #21262d;\n      --border-color: #30363d;\n      --text-main: #8b949e;\n      --text-bright: #c9d1d9;\n      --accent: #58a6ff;\n      --accent-glow: rgba(88, 166, 255, 0.15);\n      --success: #3fb950;\n      --warning: #d29922;\n      --danger: #f85149;\n      --indigo: #5385ff;\n    }\n\n    body {\n      margin: 0;\n      font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", Helvetica, Arial, sans-serif;\n      background: var(--bg-color);\n      color: var(--text-bright);\n      line-height: 1.6;\n    }\n\n    .container {\n      max-width: 1100px;\n      margin: 0 auto;\n      padding: 40px 20px;\n    }\n\n    /* Header & Stats */\n    .header {\n      display: flex;\n      align-items: center;\n      justify-content: space-between;\n      margin-bottom: 30px;\n    }\n\n    .header-title {\n      display: flex;\n      align-items: center;\n      gap: 12px;\n    }\n\n    .header-title h1 {\n      font-size: 20px;\n      font-weight: 600;\n      margin: 0;\n    }\n\n    .stats-grid {\n      display: grid;\n      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));\n      gap: 16px;\n      margin-bottom: 24px;\n    }\n\n    .stat-card {\n      background: var(--panel-bg);\n      border: 1px solid var(--border-color);\n      padding: 20px;\n      border-radius: 12px;\n    }\n\n    .stat-label {\n      font-size: 13px;\n      color: var(--text-main);\n      margin-bottom: 8px;\n    }\n\n    .stat-value {\n      font-size: 24px;\n      font-weight: 700;\n      display: flex;\n      align-items: center;\n      gap: 8px;\n    }\n\n    /* Tabs */\n    .tabs {\n      display: flex;\n      gap: 8px;\n      margin-bottom: 24px;\n      border-bottom: 1px solid var(--border-color);\n    }\n\n    .tab {\n      padding: 12px 20px;\n      cursor: pointer;\n      color: var(--text-main);\n      font-weight: 500;\n      border-bottom: 2px solid transparent;\n      transition: 0.2s;\n      position: relative;\n    }\n\n    .tab:hover {\n      color: var(--text-bright);\n    }\n\n    .tab.active {\n      color: var(--accent);\n      border-bottom-color: var(--accent);\n    }\n\n    .section {\n      display: none;\n    }\n\n    .section.active {\n      display: block;\n    }\n\n    /* Forms & Inputs */\n    .card {\n      background: var(--panel-bg);\n      border: 1px solid var(--border-color);\n      border-radius: 12px;\n      padding: 24px;\n      margin-bottom: 24px;\n    }\n\n    .form-grid {\n      display: grid;\n      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));\n      gap: 20px;\n      margin-bottom: 20px;\n    }\n\n    .form-group label {\n      display: block;\n      font-size: 13px;\n      font-weight: 500;\n      margin-bottom: 8px;\n      color: var(--text-main);\n    }\n\n    input,\n    select {\n      width: 100%;\n      padding: 10px 12px;\n      background: #0d1117;\n      border: 1px solid var(--border-color);\n      border-radius: 6px;\n      color: var(--text-bright);\n      outline: none;\n      transition: 0.2s;\n      box-sizing: border-box;\n    }\n\n    input:focus {\n      border-color: var(--accent);\n      box-shadow: 0 0 0 3px var(--accent-glow);\n    }\n\n    button {\n      padding: 10px 20px;\n      border-radius: 6px;\n      font-weight: 600;\n      cursor: pointer;\n      transition: 0.2s;\n      border: 1px solid transparent;\n      font-size: 14px;\n      display: inline-flex;\n      align-items: center;\n      justify-content: center;\n      gap: 6px;\n    }\n\n    button.primary {\n      background: var(--indigo);\n      color: white;\n    }\n\n    button.primary:hover {\n      opacity: 0.9;\n    }\n\n    button.secondary {\n      background: #21262d;\n      border-color: var(--border-color);\n      color: var(--text-bright);\n    }\n\n    button.secondary:hover {\n      background: #30363d;\n    }\n\n    button.danger {\n      background: transparent;\n      color: var(--danger);\n      border-color: var(--danger);\n    }\n\n    button.danger:hover {\n      background: var(--danger);\n      color: white;\n    }\n\n    /* List Layout for Licenses */\n    .lic-list {\n      display: flex;\n      flex-direction: column;\n      gap: 8px;\n      margin-top: 10px;\n    }\n\n    .lic-row {\n      background: var(--panel-bg);\n      border: 1px solid var(--border-color);\n      border-radius: 8px;\n      padding: 12px 16px;\n      display: grid;\n      grid-template-columns: 2fr 3fr 1fr 150px;\n      gap: 16px;\n      align-items: center;\n      transition: 0.2s;\n    }\n\n    .lic-row:hover {\n      border-color: var(--accent);\n      background: #1c2128;\n    }\n\n    .lic-header {\n      display: grid;\n      grid-template-columns: 2fr 3fr 1fr 150px;\n      gap: 16px;\n      padding: 0 16px 10px 16px;\n      font-size: 13px;\n      font-weight: 600;\n      color: var(--text-main);\n    }\n\n    @media(max-width: 800px) {\n      .lic-row {\n        grid-template-columns: 1fr;\n        align-items: start;\n      }\n\n      .lic-header {\n        display: none;\n      }\n    }\n\n    .badge {\n      padding: 2px 8px;\n      border-radius: 2em;\n      font-size: 12px;\n      font-weight: 600;\n    }\n\n    .badge-success {\n      background: rgba(63, 185, 80, 0.1);\n      color: var(--success);\n      border: 1px solid rgba(63, 185, 80, 0.2);\n    }\n\n    .badge-warning {\n      background: rgba(210, 153, 34, 0.1);\n      color: var(--warning);\n      border: 1px solid rgba(210, 153, 34, 0.2);\n    }\n\n    .badge-danger {\n      background: rgba(248, 81, 73, 0.1);\n      color: var(--danger);\n      border: 1px solid rgba(248, 81, 73, 0.2);\n    }\n\n    /* Modal */\n    .modal-overlay {\n      position: fixed;\n      inset: 0;\n      background: rgba(0, 0, 0, 0.6);\n      display: none;\n      align-items: center;\n      justify-content: center;\n      z-index: 2000;\n      backdrop-filter: blur(4px);\n    }\n\n    .modal-overlay.active {\n      display: flex;\n    }\n\n    .modal-content {\n      background: var(--panel-bg);\n      border: 1px solid var(--border-color);\n      border-radius: 12px;\n      padding: 24px;\n      width: 400px;\n      max-width: 90vw;\n    }\n\n    .modal-header {\n      font-size: 18px;\n      font-weight: 600;\n      margin-bottom: 16px;\n      color: var(--text-bright);\n    }\n\n    .modal-body {\n      margin-bottom: 24px;\n      color: var(--text-main);\n      font-size: 14px;\n    }\n\n    .modal-footer {\n      display: flex;\n      justify-content: flex-end;\n      gap: 12px;\n    }\n\n    /* Auth Overlay */\n    #adminAuth {\n      position: fixed;\n      inset: 0;\n      background: var(--bg-color);\n      display: flex;\n      justify-content: center;\n      align-items: center;\n      z-index: 1000;\n    }\n\n    .login-card {\n      width: 340px;\n      padding: 32px;\n      background: var(--panel-bg);\n      border: 1px solid var(--border-color);\n      border-radius: 12px;\n      text-align: center;\n    }\n\n    /* Custom Dropdown */\n    .dropdown-container {\n      position: relative;\n      width: 100%;\n    }\n\n    .custom-dropdown {\n      position: absolute;\n      top: calc(100% + 4px);\n      left: 0;\n      right: 0;\n      background: var(--panel-bg);\n      border: 1px solid var(--border-color);\n      border-radius: 8px;\n      z-index: 100;\n      max-height: 240px;\n      overflow-y: auto;\n      display: none;\n      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);\n    }\n\n    .custom-dropdown.active {\n      display: block;\n      animation: dropDownFade 0.2s ease-out;\n    }\n\n    @keyframes dropDownFade {\n      from {\n        opacity: 0;\n        transform: translateY(-10px);\n      }\n\n      to {\n        opacity: 1;\n        transform: translateY(0);\n      }\n    }\n\n    .dropdown-item {\n      padding: 10px 12px;\n      display: flex;\n      align-items: center;\n      justify-content: space-between;\n      cursor: pointer;\n      font-size: 13px;\n      transition: 0.2s;\n    }\n\n    .dropdown-item:hover {\n      background: #1c2128;\n      color: var(--accent);\n    }\n\n    .dropdown-item.remove-btn {\n      opacity: 0;\n      width: 24px;\n      height: 24px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      border-radius: 4px;\n      color: var(--text-main);\n      transition: 0.2s;\n    }\n\n    .dropdown-item:hover .remove-btn {\n      opacity: 1;\n    }\n\n    .dropdown-item.remove-btn:hover {\n      background: rgba(248, 81, 73, 0.1);\n      color: var(--danger);\n    }\n\n    .custom-dropdown::-webkit-scrollbar {\n      width: 6px;\n    }\n\n    .custom-dropdown::-webkit-scrollbar-thumb {\n      background: var(--border-color);\n      border-radius: 10px;\n    }\n\n    /* åˆ†é¡µæ§ä»¶æ ·å¼ */\n    .pagination {\n      display: flex;\n      justify-content: center;\n      align-items: center;\n      gap: 12px;\n      margin-top: 24px;\n      padding: 16px 0;\n      border-top: 1px solid var(--border-color);\n    }\n\n    .pagination button {\n      padding: 6px 14px;\n      font-size: 13px;\n    }\n\n    .pagination .page-info {\n      font-size: 13px;\n      color: var(--text-main);\n      background: var(--card-bg);\n      padding: 6px 12px;\n      border-radius: 6px;\n      border: 1px solid var(--border-color);\n    }\n\n    /* æ‰¹é‡æ“ä½œæ‚¬æµ®æ¡ */\n    .batch-bar {\n      position: fixed;\n      bottom: 20px;\n      left: 50%;\n      transform: translateX(-50%) translateY(100px);\n      background: var(--panel-bg);\n      border: 1px solid var(--border-color);\n      padding: 12px 24px;\n      border-radius: 12px;\n      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);\n      display: flex;\n      gap: 12px;\n      align-items: center;\n      transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);\n      opacity: 0;\n      pointer-events: none;\n      z-index: 100;\n    }\n\n    .batch-bar.active {\n      transform: translateX(-50%) translateY(0);\n      opacity: 1;\n      pointer-events: auto;\n    }\n\n    .batch-bar button {\n      padding: 6px 12px;\n      font-size: 13px;\n    }\n\n    .batch-count {\n      background: var(--accent);\n      color: var(--bg-color);\n      font-weight: bold;\n      padding: 2px 8px;\n      border-radius: 10px;\n      margin-right: 12px;\n    }\n\n    .custom-checkbox {\n      width: 16px;\n      height: 16px;\n      cursor: pointer;\n    }\n\n    /* Toast */\n    #toastContainer {\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      z-index: 3000;\n      display: flex;\n      flex-direction: column;\n      gap: 10px;\n      pointer-events: none;\n    }\n\n    .toast {\n      background: var(--panel-bg);\n      border: 1px solid var(--border-color);\n      color: var(--text-bright);\n      padding: 12px 20px;\n      border-radius: 8px;\n      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);\n      animation: toastIn 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28) forwards;\n      pointer-events: auto;\n      font-size: 13px;\n      display: flex;\n      align-items: center;\n      gap: 8px;\n    }\n\n    .toast.success {\n      border-left: 4px solid var(--success);\n    }\n\n    .toast.error {\n      border-left: 4px solid var(--danger);\n    }\n\n    .toast.warning {\n      border-left: 4px solid var(--warning);\n    }\n\n    @keyframes toastIn {\n      0% {\n        transform: translateX(120%);\n        opacity: 0;\n      }\n\n      100% {\n        transform: translateX(0);\n        opacity: 1;\n      }\n    }\n\n    @keyframes toastOut {\n      0% {\n        transform: translateX(0);\n        opacity: 1;\n      }\n\n      100% {\n        transform: translateX(120%);\n        opacity: 0;\n      }\n    }\n  </style>\n\n<body>\n\n  <div id=\"appModal\" class=\"modal-overlay\">\n    <div class=\"modal-content\">\n      <div id=\"modalTitle\" class=\"modal-header\"> æç¤º </div>\n      <div id=\"modalBody\" class=\"modal-body\"> </div>\n      <div id=\"modalInputs\" class=\"form-grid\" style=\"display:none; margin-bottom: 20px;\"> </div>\n      <div class=\"modal-footer\">\n        <button class=\"secondary\" id=\"modalBtnCancel\" onclick=\"closeModal()\"> å–æ¶ˆ </button>\n        <button class=\"primary\" id=\"modalBtnConfirm\"> ç¡®å®š </button>\n      </div>\n    </div>\n  </div>\n\n  <div id=\"adminAuth\">\n    <div class=\"login-card\">\n      <h2 style=\"margin-top:0; color:var(--text-bright)\">ğŸ”‘ èº«ä»½éªŒè¯ </h2>\n      <p style=\"color:var(--text-main); font-size:14px; margin-bottom:24px;\"> è¾“å…¥ç®¡ç†å‘˜å¯†é’¥ä»¥è¿›å…¥æ§åˆ¶å° </p>\n      <div class=\"form-group\" style=\"text-align:left; position:relative;\">\n        <input type=\"password\" id=\"globalSecret\" placeholder=\"è¾“å…¥ Admin Secret...\" value=\"\" style=\"padding-right: 40px;\">\n        <span\n          onclick=\"const i=document.getElementById('globalSecret');if(i.type==='password'){i.type='text';this.innerText='ğŸ™ˆ'}else{i.type='password';this.innerText='ğŸ‘ï¸'}\"\n          style=\"position:absolute; right:12px; top:50%; transform:translateY(-50%); cursor:pointer; opacity:0.6; user-select:none;\">ğŸ‘ï¸</span>\n      </div>\n      <button class=\"primary\" style=\"width:100%; margin-top:16px;\" onclick=\"login()\"> è¿›å…¥æ§åˆ¶å° </button>\n    </div>\n  </div>\n\n  <div class=\"container\">\n    <div class=\"header\">\n      <div class=\"header-title\">\n        <div style=\"background:var(--indigo); padding:8px; border-radius:8px; display:flex;\">\n          <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"white\" stroke-width=\"2.5\"\n            stroke-linecap=\"round\" stroke-linejoin=\"round\">\n            <rect x=\"3\" y=\"11\" width=\"18\" height=\"11\" rx=\"2\" ry=\"2\" />\n            <path d=\"M7 11V7a5 5 0 0 1 10 0v4\" />\n          </svg>\n        </div>\n        <h1> äº’ä¸ºå¡å¯†ä¸­å¿ƒ </h1>\n      </div>\n      <div style=\"display:flex; gap:8px;\">\n        <button class=\"secondary\" onclick=\"loadLicenses()\">ğŸ”„ åˆ·æ–°åˆ—è¡¨ </button>\n        <button class=\"secondary\" onclick=\"logout()\" style=\"color:var(--danger); border-color:rgba(255,100,100,0.3)\">ğŸšª\n          é€€å‡ºç™»å½• </button>\n      </div>\n    </div>\n\n    <div class=\"stats-grid\">\n      <div class=\"stat-card\">\n        <div class=\"stat-label\"> æ€»å¡å¯†æ•°(Keys) </div>\n        <div class=\"stat-value\" id=\"stat-total\"> -</div>\n      </div>\n      <div class=\"stat-card\">\n        <div class=\"stat-label\"> æ´»è·ƒä¸­(Active) </div>\n        <div class=\"stat-value\" id=\"stat-active\" style=\"color:var(--success)\"> -</div>\n      </div>\n      <div class=\"stat-card\">\n        <div class=\"stat-label\"> å·²åŠé”€(Revoked) </div>\n        <div class=\"stat-value\" id=\"stat-revoked\" style=\"color:var(--danger)\"> -</div>\n      </div>\n      <div class=\"stat-card\">\n        <div class=\"stat-label\"> ä¸´æœŸ / å·²è¿‡æœŸ(Sub) </div>\n        <div class=\"stat-value\" id=\"stat-expiring\" style=\"color:var(--warning)\"> -</div>\n      </div>\n    </div>\n\n    <div class=\"tabs\">\n      <div class=\"tab active\" onclick=\"switchTab('generate')\">âš¡ æé€Ÿç”Ÿå¡ </div>\n      <div class=\"tab\" onclick=\"switchTab('manage')\">ğŸ› ï¸ èµ„äº§ç®¡ç† </div>\n    </div>\n\n    <!--Tab: Generate-->\n    <div id=\"sec-generate\" class=\"section active\">\n      <div class=\"card\">\n        <div class=\"form-grid\">\n          <div class=\"form-group\">\n            <label>äº§å“çº¿æ ‡è¯†(Product ID) </label>\n            <div class=\"dropdown-container\">\n              <input type=\"text\" id=\"genProductId\" value=\"smartmp\" placeholder=\"è¾“å…¥ ID æˆ–ç‚¹å‡»é€‰æ‹©å†å²è®°å½•\" autocomplete=\"off\"\n                onfocus=\"showDropdown()\" oninput=\"updateProductHelpers()\">\n              <div id=\"productDropdown\" class=\"custom-dropdown\"> </div>\n            </div>\n          </div>\n          <div class=\"form-group\">\n            <label>ç»‘å®šç”¨æˆ·å / å¤‡æ³¨(å¯é€‰) </label>\n            <input type=\"text\" id=\"genUserName\" placeholder=\"ä¾‹å¦‚: å®¢æˆ·åã€å†…éƒ¨è®¢å•å·...\">\n          </div>\n        </div>\n        <div class=\"form-grid\">\n          <div class=\"form-group\">\n            <label>æ¿€æ´»ç è®¾å¤‡é…é¢(Max Devices) </label>\n            <input type=\"number\" id=\"genMaxDevices\" value=\"2\" min=\"1\" oninput=\"updateGenInfo()\">\n          </div>\n          <div class=\"form-group\">\n            <label>åˆå§‹è®¢é˜…æœ‰æ•ˆæœŸ(å¤©æ•°, ç•™ç©ºä¸ºæ°¸ä¹…) </label>\n            <input type=\"number\" id=\"genDuration\" placeholder=\"ä¾‹å¦‚: 365, 30...\">\n          </div>\n          <div class=\"form-group\">\n            <label>æ‰¹é‡ç”Ÿæˆæ•°é‡ </label>\n            <div style=\"display:flex; gap:8px; margin-bottom:4px;\">\n              <input type=\"number\" id=\"genCount\" value=\"1\" min=\"1\" max=\"100\" style=\"flex:1;\" oninput=\"updateGenInfo()\">\n              <button class=\"secondary\" onclick=\"setGenPreset(1,2,'')\"\n                style=\"padding:4px 8px; font-size:13px;\">Ã—1</button>\n              <button class=\"secondary\" onclick=\"setGenPreset(5,2,'365')\"\n                style=\"padding:4px 8px; font-size:13px;\">Ã—5/1å¹´</button>\n              <button class=\"secondary\" onclick=\"setGenPreset(10,1,'365')\"\n                style=\"padding:4px 8px; font-size:13px;\">Ã—10/1å¹´</button>\n            </div>\n            <div id=\"genInfo\" style=\"font-size:12px; color:var(--text-main); margin-top:4px;\">\n              å ç”¨é…é¢ï¼š2å° (1ä¸ªå¡å¯† Ã— 2è®¾å¤‡)\n            </div>\n          </div>\n        </div>\n        <button class=\"primary\" id=\"btnDoGen\" onclick=\"doGenerate()\" style=\"width:100%; margin-top:10px;\">âœ¨ ç«‹å³åˆ¶å¡å¹¶æ¿€æ´»è®¢é˜…\n        </button>\n\n        <div id=\"genResult\"\n          style=\"display:none; margin-top:24px; padding-top:24px; border-top:1px dashed var(--border-color);\">\n          <label style=\"color:var(--success); font-weight:600; margin-bottom:12px; display:block;\">âœ… ç”ŸæˆæˆåŠŸï¼Œè¯·å¤åˆ¶ä¿å­˜ï¼š</label>\n          <div id=\"genOutput\"\n            style=\"background:#0d1117; padding:16px; border-radius:8px; font-family:monospace; font-size:13px; margin-bottom:16px; white-space:pre-wrap; border:1px solid var(--border-color); color:var(--success);\">\n          </div>\n          <div style=\"display:flex; gap:8px;\">\n            <button class=\"secondary\" style=\"flex:2;\" onclick=\"copyGenResult()\">ğŸ“‹ å¤åˆ¶çº¯å¡å¯†æ–‡æœ¬ </button>\n            <button class=\"primary\" style=\"flex:1;\" onclick=\"switchTab('manage')\">ğŸ‘€ æŸ¥çœ‹ç®¡ç†åˆ—è¡¨ </button>\n          </div>\n        </div>\n      </div>\n    </div>\n\n    <!--Tab: Manage-->\n    <div id=\"sec-manage\" class=\"section\">\n      <div class=\"search-bar\" style=\"display:flex; flex-wrap:wrap; gap:12px; align-items:center;\">\n        <div class=\"search-input-wrap\" style=\"flex:1; min-width:200px; max-width:300px;\">\n          <input type=\"text\" id=\"keywordSearch\" placeholder=\"æœç´¢å¡å¯†ã€ç”¨æˆ·å (Ctrl+K)\" oninput=\"debounceSearch()\">\n        </div>\n\n        <!-- å¿«é€ŸçŠ¶æ€ç­›é€‰ -->\n        <div style=\"display:flex; gap:4px; margin-left:8px;\" id=\"statusFilterGroup\">\n          <button class=\"secondary\" onclick=\"filterStatus('all', this)\"\n            style=\"padding:4px 8px; font-size:12px; background:var(--accent); color:#fff;\">å…¨éƒ¨</button>\n          <button class=\"secondary\" onclick=\"filterStatus('active', this)\"\n            style=\"padding:4px 8px; font-size:12px;\">æ´»è·ƒ</button>\n          <button class=\"secondary\" onclick=\"filterStatus('revoked', this)\"\n            style=\"padding:4px 8px; font-size:12px;\">å·²åŠé”€</button>\n        </div>\n\n        <div style=\"display:flex; gap:8px; margin-left:auto; align-items:center;\">\n          <!-- æ’åº -->\n          <select id=\"sortOrder\" onchange=\"applySort()\"\n            style=\"padding:6px; font-size:12px; border-radius:6px; background:#0d1117; color:var(--text-bright); border:1px solid var(--border-color); width:auto;\">\n            <option value=\"created_desc\">æœ€æ–°ç”Ÿæˆâ†“</option>\n            <option value=\"created_asc\">æœ€æ—©ç”Ÿæˆâ†‘</option>\n            <option value=\"devices_desc\">é…é¢æœ€é«˜â†“</option>\n          </select>\n\n          <!-- äº§å“ç­›é€‰ -->\n          <select id=\"filterProductId\" onchange=\"loadLicenses()\"\n            style=\"padding:6px; font-size:12px; border-radius:6px; background:#0d1117; color:var(--text-bright); border:1px solid var(--border-color); width:auto; max-width:180px;\">\n            <option value=\"\"> æ‰€æœ‰äº§å“çº¿(Show All) </option>\n          </select>\n        </div>\n\n        <div style=\"display:flex; width:100%; justify-content:space-between; align-items:center; margin-top:8px;\">\n          <div style=\"display:flex; gap:8px;\">\n            <button class=\"secondary\" onclick=\"exportData()\" style=\"padding:4px 8px; font-size:12px;\">ğŸ“¤ å¯¼å‡ºJSON</button>\n            <button class=\"secondary\" onclick=\"exportExcel()\" style=\"padding:4px 8px; font-size:12px;\">ğŸ“Š\n              å¯¼å‡ºExcel(CSV)</button>\n            <button class=\"secondary\" onclick=\"document.getElementById('importFile').click()\"\n              style=\"padding:4px 8px; font-size:12px;\">ğŸ“¥ å¯¼å…¥é…ç½®/CSV</button>\n            <input type=\"file\" id=\"importFile\" accept=\".json,.csv\" style=\"display:none\" onchange=\"importData(event)\">\n          </div>\n          <div id=\"topPagination\"></div>\n        </div>\n      </div>\n\n      <!--é˜¶æ®µä¸€äºŒè¿‡æ¸¡ï¼šæš‚æ—¶ä¿ç•™ table å®¹å™¨åï¼Œä»¥ä¾¿ JS è¿˜èƒ½å¡«å……æ•°æ®ï¼Œä¸‹ä¸€é˜¶æ®µå°†å½»åº•æ”¹ä¸ºç½‘æ ¼å¡ç‰‡-->\n      <div id=\"licListContainer\">\n        <div class=\"table-container\">\n          <table id=\"licTable\">\n            <thead>\n              <tr>\n                <th>æ¿€æ´»ç (Key) </th>\n                <th> åŸºæœ¬ä¿¡æ¯ </th>\n                <th> å½“å‰è®¢é˜… </th>\n                <th> è®¾å¤‡ä½¿ç”¨ </th>\n                <th> å¿«æ·æ“ä½œ </th>\n              </tr>\n            </thead>\n            <tbody> </tbody>\n          </table>\n        </div>\n      </div>\n    </div>\n  </div>\n\n  <!-- æ‰¹é‡æ“ä½œæ‚¬æµ®æ¡ -->\n  <div class=\"batch-bar\" id=\"batchBar\" style=\"transition: none;\">\n    <div class=\"batch-count\" id=\"batchCountDisplay\">0</div>\n    <select id=\"batchActionSelect\"\n      style=\"background:#0d1117; color:#c9d1d9; border:1px solid #30363d; border-radius:6px; padding:6px 12px; font-size:13px; outline:none;\">\n      <option value=\"\" disabled selected>ğŸ‘‰ é€‰æ‹©æ‰¹é‡åŠ¨ä½œ...</option>\n      <optgroup label=\"åŸºç¡€æ•°æ®\">\n        <option value=\"revoke\">ğŸ”’ æ‰¹é‡åŠé”€</option>\n        <option value=\"restore\">ğŸ”“ æ‰¹é‡æ¢å¤</option>\n        <option value=\"delete\">ğŸ—‘ï¸ å½»åº•åˆ é™¤</option>\n        <option value=\"set_user_name\">ğŸ“ ä¿®æ”¹å¤‡æ³¨</option>\n        <option value=\"copy_keys\">ğŸ“‹ å¤åˆ¶çº¯å¡å¯†æ–‡æœ¬</option>\n      </optgroup>\n      <optgroup label=\"äº§å“ä¸è®¢é˜…\">\n        <option value=\"add_subscription\">ğŸš€ ç»­è´¹/åŠ äº§å“</option>\n        <option value=\"remove_subscription\">âŒ æŠ½ç¦»ç‰¹å®šäº§å“</option>\n      </optgroup>\n      <optgroup label=\"è®¾å¤‡ç®¡ç†\">\n        <option value=\"unbind\">ğŸ“± å¼ºåˆ¶è¸¢å‡ºè®¾å¤‡</option>\n        <option value=\"set_max_devices\">ğŸ”¢ ä¿®æ”¹ä¸Šçº¿é¢åº¦</option>\n      </optgroup>\n    </select>\n    <button class=\"primary\" style=\"padding:6px 16px\" onclick=\"executeBatch()\">ğŸš€ ç¡®å®šæ‰§è¡Œ</button>\n    <button class=\"secondary\" style=\"padding:6px 12px\" onclick=\"selectAllFiltered()\">â˜‘ï¸ å…¨é€‰ä¸‹æ–¹</button>\n    <button class=\"secondary\" style=\"padding:6px 12px\" onclick=\"clearBatchSelection()\">æ¸…ç©ºæ¡†é€‰</button>\n  </div>\n\n  <script>\n    let ADMIN_SECRET = \"\";\n    let ALL_LICENSES = []; // æœ¬åœ°æ•°æ®ç¼“å­˜\n    let SET_SELECTED_KEYS = new Set(); // æ‰¹é‡é€‰ä¸­çš„ keys\n\n    // åˆ†é¡µçŠ¶æ€\n    let currentPage = 1;\n    let PAGE_SIZE = 20;  // æ¯é¡µæ˜¾ç¤ºæ¡æ•°\n    let PRODUCT_HISTORY = new Set(['smartmp']);\n\n    let modalResolve = null;\n\n    function showToast(message, type = 'success') {\n      let container = document.getElementById('toastContainer');\n      if (!container) {\n        container = document.createElement('div');\n        container.id = 'toastContainer';\n        document.body.appendChild(container);\n      }\n      const toast = document.createElement('div');\n      toast.className = `toast ${type}`;\n      toast.innerHTML = message;\n      container.appendChild(toast);\n\n      setTimeout(() => {\n        toast.style.animation = 'toastOut 0.3s forwards';\n        setTimeout(() => toast.remove(), 300);\n      }, 3000);\n    }\n\n    function showModal(options) {\n      return new Promise(resolve => {\n        document.getElementById('modalTitle').innerText = options.title || 'æç¤º';\n        document.getElementById('modalBody').innerHTML = options.message || '';\n\n        const inputsDiv = document.getElementById('modalInputs');\n        inputsDiv.innerHTML = '';\n        if (options.inputs) {\n          inputsDiv.style.display = 'grid';\n          let htmlInputs = '';\n          options.inputs.forEach((inp, i) => {\n            htmlInputs += '<div class=\"form-group\"><label>' + inp.label + '</label><input type=\"' + (inp.type || 'text') + '\" id=\"modalInp' + i + '\" value=\"' + (inp.value || '') + '\" placeholder=\"' + (inp.placeholder || '') + '\"></div>';\n          });\n          inputsDiv.innerHTML = htmlInputs;\n        } else {\n          inputsDiv.style.display = 'none';\n        }\n\n        const confirmBtn = document.getElementById('modalBtnConfirm');\n        confirmBtn.className = options.danger ? 'danger' : 'primary';\n        confirmBtn.innerText = options.confirmText || 'ç¡®å®š';\n\n        const cancelBtn = document.getElementById('modalBtnCancel');\n        if (options.type === 'alert') {\n          cancelBtn.style.display = 'none';\n        } else {\n          cancelBtn.style.display = 'inline-flex';\n        }\n\n        modalResolve = resolve;\n\n        confirmBtn.onclick = () => {\n          let result = true;\n          if (options.inputs) {\n            result = options.inputs.map((_, i) => document.getElementById('modalInp' + i).value);\n          }\n          closeModal(result);\n        };\n\n        document.getElementById('appModal').classList.add('active');\n      });\n    }\n\n    function closeModal(result = false) {\n      document.getElementById('appModal').classList.remove('active');\n      if (modalResolve) modalResolve(result);\n      modalResolve = null;\n    }\n\n    async function login() {\n      const s = document.getElementById('globalSecret').value.trim();\n      if (!s) {\n        showToast('è¯·è¾“å…¥å¯†é’¥', 'warning');\n        return;\n      }\n\n      const btn = document.querySelector('#adminAuth button');\n      const originalText = btn.innerText;\n      btn.disabled = true;\n      btn.innerText = 'éªŒè¯ä¸­...';\n\n      try {\n        const res = await fetch('/api/v1/auth/admin/licenses?product_id=', {\n          headers: { 'Authorization': 'Bearer ' + s }\n        });\n\n        if (!res.ok) {\n          showToast('å¯†é’¥æ— æ•ˆï¼Œè¯·æ£€æŸ¥', 'error');\n          throw new Error();\n        }\n\n        ADMIN_SECRET = s;\n        localStorage.setItem('hw_admin_secret', s);\n        document.getElementById('adminAuth').style.display = 'none';\n        loadLicenses();\n      } catch (e) {\n        // è¯·æ±‚å¤±è´¥è‡ªåŠ¨æ¢å¤æŒ‰é’®çŠ¶æ€\n        if (e.message !== '') {\n          showToast('ç½‘ç»œæˆ–è¿æ¥å¼‚å¸¸: ' + e.message, 'error');\n        } else {\n          // ç”± response.ok !== true æŠ›å‡ºçš„ç©º Error\n        }\n      } finally {\n        if (btn) {\n          btn.disabled = false;\n          btn.innerText = originalText;\n        }\n      }\n    }\n\n    function logout() {\n      ADMIN_SECRET = \"\";\n      localStorage.removeItem('hw_admin_secret');\n      document.getElementById('globalSecret').value = '';\n      document.getElementById('adminAuth').style.display = 'flex';\n      document.getElementById('licListContainer').innerHTML = '';\n      ALL_LICENSES = [];\n      updateStats();\n    }\n\n    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨å°è¯•ä»æœ¬åœ°ç¼“å­˜æ¢å¤ä¼šè¯\n    window.addEventListener('DOMContentLoaded', () => {\n      const savedSecret = localStorage.getItem('hw_admin_secret');\n      if (savedSecret) {\n        document.getElementById('globalSecret').value = savedSecret;\n        login();\n      }\n    });\n\n    // å›è½¦å¿«æ·ç™»å½•\n    document.getElementById('globalSecret').onkeyup = (e) => { if (e.key === 'Enter') login(); };\n\n    function switchTab(tab) {\n      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));\n      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));\n      const target = (event && event.target) ? event.target : document.querySelector('.tab[onclick*=\"' + tab + '\"]');\n      if (target) target.classList.add('active');\n      document.getElementById('sec-' + tab).classList.add('active');\n      if (tab === 'manage') loadLicenses();\n    }\n\n    let currentPagination = null;\n    let currentStats = null;\n\n    // è®¡ç®—å¹¶æ›´æ–°é¡¶éƒ¨ç»Ÿè®¡æŒ‡æ ‡\n    function updateStats(stats) {\n      if (!stats) return;\n      document.getElementById('stat-total').innerText = stats.total;\n      document.getElementById('stat-active').innerText = stats.active;\n      document.getElementById('stat-revoked').innerText = stats.revoked;\n      document.getElementById('stat-expiring').innerText = stats.expiring;\n\n      // ä¸ºä¸´æœŸçœ‹æ¿ç»‘å®šç‚¹å‡»ç­›é€‰èƒ½åŠ› (ä»…ç»‘å®šä¸€æ¬¡é˜²é‡å¤)\n      const expCard = document.getElementById('stat-expiring').parentElement;\n      expCard.style.cursor = 'pointer';\n      if (!expCard.dataset.bound) {\n        expCard.onmouseenter = () => expCard.style.border = '1px solid var(--warning)';\n        expCard.onmouseleave = () => expCard.style.border = '1px solid var(--border-color)';\n        expCard.onclick = () => {\n          // æ¸…ç©ºå…¶ä»–é«˜äº®æŒ‰é’®\n          document.querySelectorAll('#statusFilterGroup button').forEach(btn => {\n            btn.style.background = '';\n            btn.style.color = 'var(--text-bright)';\n          });\n          filterStatus('expiring', null);\n        };\n        expCard.dataset.bound = 'true';\n      }\n    }\n\n    // æ˜¾ç¤º/éšè—ä¸‹æ‹‰æ¡†\n    function showDropdown() {\n      document.getElementById('productDropdown').classList.add('active');\n      updateProductHelpers();\n    }\n    function hideDropdown() {\n      setTimeout(() => {\n        document.getElementById('productDropdown').classList.remove('active');\n      }, 200); // å»¶è¿Ÿå…³é—­ä»¥ä¾¿æ•è·ç‚¹å‡»\n    }\n\n    // ä»å†å²è®°å½•ä¸­ç‰©ç†ç§»é™¤æŸä¸ªäº§å“ ID\n    function removeFromHistory(e, id) {\n      if (e) e.stopPropagation(); // é˜²æ­¢è§¦å‘é€‰æ‹©\n      showModal({\n        title: 'ç§»é™¤è®°å½•',\n        message: 'ç¡®å®šä»å†å²å»ºè®®ä¸­ç§»é™¤ \"' + id + '\" å—ï¼Ÿ',\n        confirmText: 'ç¡®å®šç§»é™¤',\n        danger: true\n      }).then(confirmed => {\n        if (confirmed) {\n          PRODUCT_HISTORY.delete(id);\n          updateProductHelpers();\n        }\n      });\n    }\n\n    // ç”Ÿå¡åŒºé€‰æ‹©äº§å“ ID çš„è¾…åŠ©å‡½æ•°\n    function setGenProduct(val) {\n      document.getElementById('genProductId').value = val;\n      updateProductHelpers();\n      hideDropdown();\n    }\n\n    // æ›´æ–°äº§å“è¾…åŠ©å™¨ï¼ˆåŒ…æ‹¬ç­›é€‰ä¸‹æ‹‰å’Œè‡ªå®šä¹‰ç”Ÿå¡ä¸‹æ‹‰æ¡†ï¼‰\n    function updateProductHelpers() {\n      const filterSelect = document.getElementById('filterProductId');\n      const dropdown = document.getElementById('productDropdown');\n      const genInput = document.getElementById('genProductId');\n\n      // 1. åŒæ­¥å½“å‰æ‰€æœ‰å­˜é‡äº§å“åˆ°å†å²åº“\n      ALL_LICENSES.forEach(l => PRODUCT_HISTORY.add(l.product_id));\n\n      // 2. æ›´æ–°ç®¡ç†åˆ—è¡¨ä¸Šæ–¹çš„â€œç­›é€‰â€ä¸‹æ‹‰æ¡†\n      const currentFilter = filterSelect.value;\n      filterSelect.innerHTML = '<option value=\"\">æ‰€æœ‰äº§å“çº¿ (Show All)</option>';\n      [...PRODUCT_HISTORY].sort().forEach(p => {\n        const opt = document.createElement('option');\n        opt.value = p; opt.innerText = p;\n        filterSelect.appendChild(opt);\n      });\n      filterSelect.value = currentFilter;\n\n      // 3. æ›´æ–°ç”Ÿå¡åŒºçš„â€œè‡ªå®šä¹‰æœç´¢ä¸‹æ‹‰æ¡†â€\n      const searchVal = genInput.value.toLowerCase();\n      const matches = [...PRODUCT_HISTORY].filter(p => !searchVal || p.toLowerCase().includes(searchVal)).sort();\n\n      if (matches.length === 0) {\n        dropdown.innerHTML = '<div style=\"padding:12px; font-size:12px; color:var(--text-main); text-align:center;\">æœªæ‰¾åˆ°åŒ¹é…çš„å†å²è®°å½•</div>';\n      } else {\n        let listHtml = '';\n        matches.forEach(p => {\n          listHtml += `<div class=\"dropdown-item\" onclick=\"setGenProduct('${p}')\">` +\n            `<span>${p}</span>` +\n            `<div class=\"remove-btn\" onclick=\"removeFromHistory(event, '${p}')\" title=\"ä»å†å²ä¸­ç§»é™¤\">âœ•</div>` +\n            `</div>`;\n        });\n        dropdown.innerHTML = listHtml;\n      }\n    }\n\n    // ç‚¹å‡»å¤–éƒ¨è‡ªåŠ¨å…³é—­ä¸‹æ‹‰\n    document.addEventListener('click', (e) => {\n      if (!e.target.closest('.dropdown-container')) {\n        document.getElementById('productDropdown').classList.remove('active');\n      }\n    });\n\n    // åç«¯æ¸¸æ ‡åŠ è½½æ•°æ®\n    async function loadLicenses() {\n      const searchKw = document.getElementById('keywordSearch') ? document.getElementById('keywordSearch').value.trim() : '';\n      const pId = document.getElementById('filterProductId') ? document.getElementById('filterProductId').value : '';\n      const container = document.getElementById('licListContainer');\n\n      const queryParams = new URLSearchParams({\n        page: currentPage,\n        limit: PAGE_SIZE,\n        search: searchKw,\n        product_id: pId,\n        status: currentStatusFilter,\n        sort: currentSort\n      });\n\n      // é›¶çŠ¶æ€æ—¶ç»™å¤§å ä½ç¬¦ï¼Œæœ‰æ•°æ®å¢é‡æ—¶ä½¿ç”¨è½»å¾®é€æ˜åº¦ä¿æŠ¤ä¹è§‚UI\n      if (!document.querySelector('.lic-row')) {\n        container.innerHTML = '<div style=\"text-align:center; padding:50px; color:var(--text-main)\">ğŸš€ æ­£åœ¨åŒæ­¥è¾¹ç¼˜æ•°æ®...</div>';\n      } else {\n        container.style.opacity = '0.6';\n      }\n\n      try {\n        const res = await fetch('/api/v1/auth/admin/licenses/paged?' + queryParams.toString(), {\n          headers: { 'Authorization': 'Bearer ' + ADMIN_SECRET }\n        });\n        const data = await res.json();\n\n        container.style.opacity = '1';\n\n        if (!data.success) {\n          if (res.status === 401) {\n            logout();\n            showModal({ title: 'ä¼šè¯å¤±æ•ˆ', message: 'å¯†é’¥æ— æ•ˆæˆ–å·²æ›´æ”¹ï¼Œè¯·é‡æ–°è¾“å…¥', type: 'alert' });\n            return;\n          }\n          container.innerHTML = '<div style=\"padding:20px; color:var(--danger)\">âŒ è·å–å¤±è´¥: ' + data.msg + '</div>';\n          return;\n        }\n\n        ALL_LICENSES = data.data; // é™çº§ä¸ºä»…ç¼“å­˜å½“å‰é¡µæ•°ç»„ï¼Œç”¨äºçƒ­å˜æ›´æ˜ å°„\n        currentPagination = data.pagination;\n        currentStats = data.stats;\n\n        updateStats(currentStats);\n        updateProductHelpers();\n        renderCards(ALL_LICENSES, currentPagination);\n      } catch (e) {\n        container.style.opacity = '1';\n        container.innerHTML = '<div style=\"padding:20px; color:var(--danger)\">âš ï¸ æ— æ³•è¿æ¥æœåŠ¡å™¨</div>';\n      }\n    }\n\n    // ä¹è§‚ UI å†…éƒ¨é™é»˜çƒ­æ¸²æŸ“å™¨ï¼Œä¸å¼•å‘é—ªçƒä¸ç½‘ç»œæ³¢åŠ¨\n    function reRenderCards() {\n      renderCards(ALL_LICENSES, currentPagination);\n    }\n\n    // æ¸²æŸ“åˆ—è¡¨è§†å›¾å¸ƒå±€\n    function renderCards(list, pagination = null) {\n      const container = document.getElementById('licListContainer');\n      if (list.length === 0) {\n        container.innerHTML = '<div style=\"text-align:center; padding:50px; color:var(--text-main)\">ğŸ“­ æš‚æ— ç›¸å…³å¡å¯†æ•°æ®</div>';\n        const topPag = document.getElementById('topPagination');\n        if (topPag) topPag.innerHTML = '';\n        return;\n      }\n\n      // æ‰€æœ‰çš„ list å³ä¸ºå·²ä»åç«¯åˆ‡ç‰‡å¥½çš„ pagedList\n      const pagedList = list;\n\n      // è·å–æ‰€æœ‰å½“å‰é¡µçš„å¡å¯† IDï¼Œä»¥ä¾¿å…¨é€‰æ¯”è¾ƒä½¿ç”¨\n      const currentFilteredKeys = pagedList.map(l => l.license_key);\n\n      // æ£€æŸ¥æ˜¯å¦åœ¨å½“å‰åˆ—è¡¨å’Œè·¨é¡µé›†åˆä¸­å…¨é€‰äº†\n      const isAllChecked = pagedList.length > 0 && pagedList.every(l => SET_SELECTED_KEYS.has(l.license_key));\n\n      let html = '<div class=\"lic-list\">';\n      html += `\n    <div class=\"lic-header\" style=\"grid-template-columns: 30px 1.5fr 1.5fr 1fr 1fr;\">\n      <div><input type=\"checkbox\" class=\"custom-checkbox\" ${isAllChecked ? 'checked' : ''} onclick=\"toggleAllCheckboxes(this)\" title=\"å…¨é€‰å½“å‰åˆ—è¡¨\"></div>\n      <div>æˆæƒæ ‡è¯† & ä½¿ç”¨è€…</div>\n      <div>äº§å“æƒé™ä¸æœ‰æ•ˆæœŸ</div>\n      <div>åœ¨çº¿è®¾å¤‡</div>\n      <div style=\"text-align:right\">æ“ä½œ</div>\n    </div>\n  `;\n\n      const now = new Date();\n\n      // åŒæ­¥åˆ†é¡µå…ƒæ•°æ®ä¸ºç»„ä»¶ä½œç”¨åŸŸå˜é‡\n      const totalPages = pagination ? pagination.total_pages : 1;\n      const totalItems = pagination ? pagination.total : list.length;\n      if (currentPage > totalPages) currentPage = totalPages;\n      if (currentPage < 1) currentPage = 1;\n\n      pagedList.forEach((lic) => {\n        // å‡†å¤‡è®¢é˜…çŠ¶æ€ HTML\n        let subHtml = '';\n        if (lic.subscriptions && lic.subscriptions.length > 0) {\n          subHtml = lic.subscriptions.map((s) => {\n            let text = 'æ°¸ ä¹…';\n            let cls = 'badge-success';\n            if (s.expires_at) {\n              const days = Math.ceil((new Date(s.expires_at) - now) / (86400000));\n              text = days > 0 ? 'å‰© ' + days + ' å¤©' : 'å·²è¿‡æœŸ';\n              cls = days > 7 ? 'badge-success' : (days > 0 ? 'badge-warning' : 'badge-danger');\n            }\n            return '<span class=\"badge ' + cls + '\" style=\"margin-right:4px;\">' + s.product_id + ': ' + text + '</span>';\n          }).join('');\n        } else {\n          subHtml = '<span style=\"color:var(--text-main); font-size:11px; font-style:italic\">æš‚æ— è®¢é˜…äº§å“</span>';\n        }\n\n        const isRevoked = lic.status === 'revoked';\n        const devicePct = Math.min(100, (lic.current_devices / lic.max_devices) * 100);\n\n        html += `\n      <div class=\"lic-row\" style=\"grid-template-columns: 30px 1.5fr 1.5fr 1fr 1fr;\">\n        <!-- Col 0: Checkbox -->\n        <div style=\"display:flex; align-items:center;\">\n          <input type=\"checkbox\" class=\"custom-checkbox row-checkbox\" value=\"${lic.license_key}\" ${SET_SELECTED_KEYS.has(lic.license_key) ? 'checked' : ''} onclick=\"toggleBatchItem('${lic.license_key}', this.checked)\">\n        </div>\n        \n        <!-- Col 1: åŸºæœ¬ä¿¡æ¯ -->\n        <div style=\"display:flex; align-items:center; gap:12px; min-width:0;\">\n          <div style=\"width:36px; height:36px; flex-shrink:0; background:#30363d; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-weight:700; font-size:14px;\">\n            ${(lic.user_name || '?')[0].toUpperCase()}\n          </div>\n          <div style=\"min-width:0; overflow:hidden;\">\n            <div style=\"display:flex; align-items:center; gap:6px; margin-bottom:4px;\">\n              <span style=\"font-weight:600; font-size:13px; color:var(--text-bright); overflow:hidden; text-overflow:ellipsis; white-space:nowrap;\">${lic.user_name || '<span style=\"color:var(--text-main); font-style:italic\">æœªæŒ‡å®šç”¨æˆ·</span>'}</span>\n              <span style=\"cursor:pointer; opacity:0.6; font-size:11px;\" onclick=\"editUserName('${lic.license_key}','${lic.user_name || \"\"}')\" title=\"ä¿®æ”¹ç”¨æˆ·å¤‡æ³¨\">âœï¸</span>\n              <span class=\"badge ${isRevoked ? 'badge-danger' : 'badge-success'}\" style=\"transform: scale(0.85); transform-origin:left; margin-left:2px;\">${lic.status.toUpperCase()}</span>\n            </div>\n            <div style=\"display:flex; align-items:center; gap:6px;\">\n              <span style=\"font-family:monospace; font-size:12px; color:var(--accent);\">${lic.license_key}</span>\n              <span style=\"cursor:pointer; opacity:0.6; font-size:12px;\" onclick=\"copyText('${lic.license_key}')\" title=\"å¤åˆ¶å¡å¯†\">ğŸ“‹</span>\n            </div>\n          </div>\n        </div>\n        \n        <!-- Col 2: è®¢é˜…æ ‡ç­¾ -->\n        <div style=\"font-size:12px; display:flex; flex-wrap:wrap; gap:4px; align-items:center;\">\n          ${subHtml}\n          <span onclick=\"addSub('${lic.license_key}')\" style=\"color:var(--accent); cursor:pointer; font-weight:500; font-size:11px; margin-left:4px; padding:2px 6px; background:var(--accent-glow); border-radius:4px;\">+ ç»­è´¹ç®¡ç†</span>\n        </div>\n\n        <!-- Col 3: è®¾å¤‡å ç”¨ -->\n        <div style=\"font-size:12px; display:flex; flex-direction:column; justify-content:center;\">\n          <div style=\"color:var(--text-bright); margin-bottom:4px; font-weight:500; display:flex; align-items:center;\">\n            <div style=\"flex-shrink:0;\">${lic.current_devices} <span style=\"color:var(--text-main); font-weight:normal;\">/ ${lic.max_devices} å°</span></div>\n            <button class=\"secondary\" onclick=\"toggleDevicePanel('${lic.license_key}')\" style=\"margin-left:6px; padding:2px 6px; font-size:11px; height:auto; background:var(--panel-bg); border-color:#30363d; flex-shrink:0;\" title=\"å±•å¼€æŸ¥çœ‹å…·ä½“è®¾å¤‡\">ğŸ” è¯¦æƒ…</button>\n          </div>\n          <div style=\"height:4px; width:100%; max-width:80px; background:#30363d; border-radius:2px; overflow:hidden;\">\n            <div style=\"width:${devicePct}%; height:100%; background:var(--accent);\"></div>\n          </div>\n        </div>\n\n        <!-- Col 4: æ“ä½œ -->\n        <div style=\"display:flex; gap:8px; justify-content:flex-end;\">\n          <button class=\"secondary\" style=\"padding:4px 8px; font-size:12px;\" onclick=\"toggleStatus('${lic.license_key}', '${isRevoked ? 'active' : 'revoked'}')\">\n            ${isRevoked ? 'ğŸ”“ æ¢å¤' : 'ğŸ”’ åŠé”€'}\n          </button>\n          <button class=\"danger\" style=\"padding:4px 8px; font-size:12px;\" onclick=\"deleteLic('${lic.license_key}')\" title=\"å½»åº•åˆ é™¤\">ğŸ—‘ï¸</button>\n        </div>\n      </div>\n      <!-- åŠ¨æ€è®¾å¤‡é¢æ¿æ’æ§½ -->\n      <div id=\"devicePanel_${lic.license_key}\" style=\"display:none; grid-column:1/-1; background:#0d1117; border-top:1px dashed #30363d; padding:12px 16px;\"></div>\n    `;\n      });\n\n      html += '</div>';\n\n      html += '</div>';\n\n      // ==========================================\n      // æ›´æ–°é¡¶éƒ¨åŠåº•éƒ¨åˆ†é¡µå¯¼èˆª (æå–é€»è¾‘)\n      // ==========================================\n      const renderPagination = () => {\n        if (totalItems === 0) return '';\n        return `\n          <div style=\"display:flex; align-items:stretch; gap:8px;\">\n            <select style=\"padding:0 12px; font-size:14px; border-radius:6px; background:#21262d; color:var(--text-bright); border:1px solid var(--border-color); outline:none; cursor:pointer;\" onchange=\"changePageSize(this.value)\">\n              <option value=\"10\" ${PAGE_SIZE === 10 ? 'selected' : ''}>10æ¡/é¡µ</option>\n              <option value=\"20\" ${PAGE_SIZE === 20 ? 'selected' : ''}>20æ¡/é¡µ</option>\n              <option value=\"50\" ${PAGE_SIZE === 50 ? 'selected' : ''}>50æ¡/é¡µ</option>\n              <option value=\"100\" ${PAGE_SIZE === 100 ? 'selected' : ''}>100æ¡/é¡µ</option>\n            </select>\n            <button class=\"secondary\" style=\"white-space:nowrap; flex-shrink:0;\" onclick=\"goToPage(${currentPage - 1})\" ${currentPage === 1 ? 'disabled style=\"opacity:0.5;cursor:not-allowed\"' : ''}>â† ä¸Šä¸€é¡µ</button>\n            <div style=\"display:flex; align-items:center; padding:0 16px; font-size:14px; color:var(--text-main); background:var(--card-bg); border-radius:6px; border:1px solid var(--border-color); white-space:nowrap; flex-shrink:0;\">\n              ç¬¬ <span style=\"color:var(--text-bright); font-weight:bold; margin:0 4px;\">${currentPage}</span>/ ${totalPages} é¡µ\n            </div>\n            <button class=\"secondary\" style=\"white-space:nowrap; flex-shrink:0;\" onclick=\"goToPage(${currentPage + 1})\" ${currentPage === totalPages ? 'disabled style=\"opacity:0.5;cursor:not-allowed\"' : ''}>ä¸‹ä¸€é¡µ â†’</button>\n          </div>\n        `;\n      };\n\n      const topPag = document.getElementById('topPagination');\n      if (topPag) {\n        topPag.innerHTML = renderPagination();\n      }\n\n      container.innerHTML = html;\n    }\n\n    // åˆ‡æ¢åˆ†é¡µå¤§å°\n    function changePageSize(size) {\n      PAGE_SIZE = parseInt(size);\n      currentPage = 1;\n      filterLocalList(false);\n    }\n\n    // åˆ†é¡µè·³è½¬å‡½æ•°\n    function goToPage(page) {\n      currentPage = page;\n      filterLocalList(false);\n      window.scrollTo({ top: document.getElementById('licListContainer').offsetTop - 60, behavior: 'smooth' });\n    }\n\n    // é˜²æŠ–æœç´¢ï¼ˆ300mså»¶è¿Ÿï¼‰\n    let searchTimer = null;\n    function debounceSearch() {\n      clearTimeout(searchTimer);\n      searchTimer = setTimeout(() => filterLocalList(true), 300);\n    }\n\n    // çŠ¶æ€ç­›é€‰\n    let currentStatusFilter = 'all';\n    function filterStatus(status, btnElement) {\n      currentStatusFilter = status;\n      document.querySelectorAll('#statusFilterGroup button').forEach(btn => {\n        btn.style.background = '';\n        btn.style.color = 'var(--text-bright)';\n      });\n      if (btnElement) {\n        btnElement.style.background = 'var(--accent)';\n        btnElement.style.color = '#fff';\n      }\n      filterLocalList(true);\n    }\n\n    // æ’åº\n    let currentSort = 'created_desc';\n    function applySort() {\n      currentSort = document.getElementById('sortOrder').value;\n      filterLocalList(true);\n    }\n\n    // ç”Ÿå¡è¾…åŠ©è®¡ç®—\n    function updateGenInfo() {\n      const count = parseInt(document.getElementById('genCount').value) || 1;\n      const maxDevices = parseInt(document.getElementById('genMaxDevices').value) || 2;\n      const totalDevices = count * maxDevices;\n      document.getElementById('genInfo').innerText = `å ç”¨æ•´ä½“é…é¢ï¼š${totalDevices}å° (${count}å¼ å¡ Ã— ${maxDevices}å°)`;\n    }\n\n    function setGenPreset(count, maxDevices, duration) {\n      document.getElementById('genCount').value = count;\n      document.getElementById('genMaxDevices').value = maxDevices;\n      document.getElementById('genDuration').value = duration || '';\n      updateGenInfo();\n    }\n\n    // æœç´¢è¿‡æ»¤ä¸å¤šç»´æ’åºæ ¸å¿ƒ\n    function filterLocalList(resetPage = true) {\n      if (resetPage) currentPage = 1;\n      loadLicenses(); // æ‰€æœ‰æ’åºä¸è¿‡æ»¤è®¡ç®—å¼•æ“ä¸‹æ²‰è‡³åç«¯\n    }\n\n    // ç”Ÿå¡é€»è¾‘\n    async function doGenerate() {\n      const btn = document.getElementById('btnDoGen');\n      const pId = document.getElementById('genProductId').value;\n      const uName = document.getElementById('genUserName').value;\n      const cnt = parseInt(document.getElementById('genCount').value);\n      const mD = parseInt(document.getElementById('genMaxDevices').value);\n      const dur = document.getElementById('genDuration').value;\n\n      btn.disabled = true; btn.innerText = \"âš¡ æ­£åœ¨ç‚¼åˆ¶æ¿€æ´»ç ...\";\n\n      try {\n        const res = await fetch('/api/v1/auth/admin/generate', {\n          method: 'POST',\n          headers: { 'Authorization': 'Bearer ' + ADMIN_SECRET, 'Content-Type': 'application/json' },\n          body: JSON.stringify({ product_id: pId, user_name: uName, count: cnt, max_devices: mD, duration_days: dur ? parseInt(dur) : null })\n        });\n        const data = await res.json();\n        if (data.success) {\n          showToast(`æˆåŠŸç”Ÿæˆ ${data.keys.length} å¼ å¡å¯†ï¼Œå·²è‡ªåŠ¨ä¸ºæ‚¨é€‰ä¸­ï¼`, 'success');\n          document.getElementById('genResult').style.display = 'block';\n          document.getElementById('genOutput').innerText = data.keys.join('\\n');\n\n          // å¿ƒæ™ºæµè½¬ï¼šé‡ç½®åˆ—è¡¨è§†å›¾å±æ€§\n          clearBatchSelection();\n          data.keys.forEach(k => SET_SELECTED_KEYS.add(k));\n          document.getElementById('keywordSearch').value = '';\n          document.getElementById('filterProductId').value = '';\n          filterStatus('all', document.querySelector('#statusFilterGroup button'));\n\n          // è·³è½¬ä¸æ‰§è¡Œ\n          switchTab('manage');\n          // å› ä¸º switchTab('manage') å†…è°ƒç”¨äº†ä¸è¿”å› Promise çš„ loadLicenses()ï¼Œ\n          // ç”¨çŸ­å»¶æ—¶æˆ–æ‹¦æˆªå»ç¡®ä¿åº•éƒ¨ batchBar å‡ºç°\n          setTimeout(() => {\n            updateBatchBar();\n            document.getElementById('batchBar').classList.add('pulse-highlight');\n            setTimeout(() => document.getElementById('batchBar').classList.remove('pulse-highlight'), 1000);\n          }, 800);\n\n        } else { showToast('é”™è¯¯: ' + data.msg, 'error'); }\n      } catch (e) { showToast('é€šè®¯å¤±è´¥: ' + e.message, 'error'); }\n      finally { btn.disabled = false; btn.innerText = \"âœ¨ ç«‹å³åˆ¶å¡å¹¶æ¿€æ´»è®¢é˜…\"; }\n    }\n\n    // API äº¤äº’å‡½æ•°\n    async function toggleStatus(key, status) {\n      const isRestore = status === 'active';\n      const confirmed = await showModal({\n        title: isRestore ? 'ğŸ”“ æ¢å¤ä½¿ç”¨' : 'ğŸ”’ åŠé”€å¡å¯†',\n        message: 'ç¡®å®šè¦' + (isRestore ? 'æ¢å¤' : 'åŠé”€') + 'å¡å¯†[<span style=\"color:var(--accent)\">' + key + '</span>]å—ï¼Ÿ',\n        confirmText: 'ç¡®å®š',\n        danger: !isRestore\n      });\n      if (!confirmed) return;\n\n      try {\n        const res = await fetch('/api/v1/auth/admin/licenses/status', {\n          method: 'POST',\n          headers: { 'Authorization': 'Bearer ' + ADMIN_SECRET, 'Content-Type': 'application/json' },\n          body: JSON.stringify({ license_key: key, status })\n        });\n        const data = await res.json();\n        if (data.success) {\n          const lic = ALL_LICENSES.find(l => l.license_key === key);\n          if (lic) {\n            lic.status = status;\n            if (currentStats) {\n              if (status === 'active') { currentStats.active++; currentStats.revoked--; }\n              else { currentStats.active--; currentStats.revoked++; }\n            }\n            updateStats(currentStats);\n            reRenderCards(); // é«˜æ•ˆé™æ€é‡ç»˜\n          }\n          showToast(data.msg || 'çŠ¶æ€å·²æ›´æ–°', 'success');\n        } else {\n          showToast(data.msg || 'æ“ä½œå¤±è´¥', 'error');\n        }\n      } catch (e) {\n        showToast('ç½‘ç»œé”™è¯¯: ' + e.message, 'error');\n      }\n    }\n\n    async function deleteLic(key) {\n      const confirmed = await showModal({\n        title: 'ğŸ—‘ï¸ å½»åº•åœäº§',\n        message: 'âš ï¸ å±é™©: ç¡®å®šåˆ é™¤å¡å¯†[<span style=\"color:var(--danger)\">' + key + '</span>]å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼',\n        confirmText: 'ç¡®è®¤åˆ é™¤',\n        danger: true\n      });\n      if (!confirmed) return;\n\n      try {\n        const res = await fetch('/api/v1/auth/admin/licenses', {\n          method: 'DELETE',\n          headers: { 'Authorization': 'Bearer ' + ADMIN_SECRET, 'Content-Type': 'application/json' },\n          body: JSON.stringify({ license_key: key })\n        });\n        const data = await res.json();\n        if (data.success) {\n          ALL_LICENSES = ALL_LICENSES.filter(l => l.license_key !== key);\n          SET_SELECTED_KEYS.delete(key);\n          updateBatchBar();\n\n          if (currentStats && currentStats.total > 0) currentStats.total--;\n          updateStats(currentStats);\n\n          // å¦‚æœå½“å‰é¡µè¢«åˆ ç©ºï¼Œä¸”ä¸æ˜¯ç¬¬ä¸€é¡µï¼Œè‡ªåŠ¨é€€ä¸€é¡µæ‹‰å–\n          if (ALL_LICENSES.length === 0 && currentPage > 1) {\n            currentPage--;\n          }\n          filterLocalList(false); // ç‰©ç†åˆ é™¤å¿…é¡»è®©åç«¯å¡«è¡¥ç©ºä½\n          showToast('å·²å½»åº•åˆ é™¤è¯¥å¡å¯†', 'success');\n        } else {\n          showToast(data.msg || 'åˆ é™¤å¤±è´¥', 'error');\n        }\n      } catch (e) {\n        showToast('ç½‘ç»œé”™è¯¯: ' + e.message, 'error');\n      }\n    }\n\n    async function editUserName(key, cur) {\n      const res = await showModal({\n        title: 'âœï¸ ä¿®æ”¹ç”¨æˆ·å¤‡æ³¨',\n        inputs: [{ label: 'ç”¨æˆ·åæˆ–å†…éƒ¨å¤‡æ³¨', value: cur, placeholder: 'è¾“å…¥æ–°å¤‡æ³¨' }],\n        confirmText: 'ä¿å­˜ä¿®æ”¹'\n      });\n      if (!res) return;\n      const n = res[0];\n\n      try {\n        const fetchRes = await fetch('/api/v1/auth/admin/licenses/user', {\n          method: 'POST',\n          headers: { 'Authorization': 'Bearer ' + ADMIN_SECRET, 'Content-Type': 'application/json' },\n          body: JSON.stringify({ license_key: key, user_name: n })\n        });\n        const data = await fetchRes.json();\n        if (data.success) {\n          const lic = ALL_LICENSES.find(l => l.license_key === key);\n          if (lic) {\n            lic.user_name = n;\n            reRenderCards(); // æ–‡æœ¬çƒ­å˜æ›´ï¼Œé›¶é—ªçƒ\n          }\n          showToast('å¤‡æ³¨å·²æ›´æ–°', 'success');\n        } else {\n          showToast(data.msg || 'æ›´æ–°å¤±è´¥', 'error');\n        }\n      } catch (e) {\n        showToast('ç½‘ç»œé”™è¯¯: ' + e.message, 'error');\n      }\n    }\n    // æ·»åŠ äº§å“ç»­è´¹ç®¡ç†\n    async function addSub(key) {\n      const res = await showModal({\n        title: 'â• æ·»åŠ è®¢é˜…æˆ–ç»­è´¹',\n        message: 'æ­£åœ¨ä¸º <b>' + key + '</b> é…ç½®æƒé™ã€‚<br/><span style=\"color:var(--warning); font-size:12px;\">æ³¨ï¼šå¦‚éœ€æ¸…é™¤è¯¯ç»‘äº§å“ï¼Œè¯·å¡«å…¥äº§å“ ID å¹¶å°†æ—¶é•¿è®¾ä¸º 0ã€‚</span>',\n        inputs: [\n          { label: 'äº§å“çº¿æ ‡è¯† (Product ID)', value: 'smartmp', placeholder: 'å¦‚ smartmp' },\n          { label: 'ç»­è´¹æ—¶é•¿ (å¤©æ•°)', value: '365', placeholder: 'å¡« 365 å³åŠ ä¸€å¹´ï¼Œå¡« 0 æ¸…é™¤ï¼Œç•™ç©ºæ°¸ä¹…' }\n        ],\n        confirmText: 'ç¡®è®¤åŠç†'\n      });\n\n      if (!res) return;\n      const pId = res[0] ? res[0].trim() : '';\n      const dVal = res[1] ? res[1].trim() : '';\n      if (!pId) return;\n\n      let days = null;\n      if (dVal !== '') {\n        days = parseInt(dVal);\n        if (isNaN(days)) return showModal({ title: 'é”™è¯¯', message: 'å¤©æ•°å¿…é¡»æ˜¯çº¯æ•°å­—', type: 'alert' });\n      }\n\n      try {\n        const fRes = await fetch('/api/v1/auth/admin/subscriptions', {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + ADMIN_SECRET },\n          body: JSON.stringify({ license_key: key, product_id: pId, duration_days: days })\n        });\n        const data = await fRes.json();\n\n        if (data.success) {\n          showToast(data.deleted ? 'æƒé™é…ç½®å·²æ¸…ç†' : 'è®¢é˜…å·²ç»­æœŸæ›´æ–°æˆåŠŸ', 'success');\n          const lic = ALL_LICENSES.find(l => l.license_key === key);\n          if (lic) {\n            if (data.deleted) {\n              lic.subscriptions = (lic.subscriptions || []).filter(s => s.product_id !== pId);\n            } else {\n              const subObj = { product_id: pId, expires_at: data.expires_at };\n              lic.subscriptions = lic.subscriptions || [];\n              const existIdx = lic.subscriptions.findIndex(s => s.product_id === pId);\n              if (existIdx >= 0) {\n                lic.subscriptions[existIdx] = subObj;\n              } else {\n                lic.subscriptions.push(subObj);\n              }\n            }\n            updateProductHelpers();\n            filterLocalList(false); // å±€éƒ¨çƒ­æ›´æ–°\n          }\n        } else {\n          showToast(data.msg || 'æ“ä½œæœªç”Ÿæ•ˆ', 'error');\n        }\n      } catch (e) {\n        showModal({ title: 'å‘ç”Ÿé”™è¯¯', message: e.message, type: 'alert' });\n      }\n    }\n\n    function copyText(t) {\n      navigator.clipboard.writeText(t);\n      const btn = window.event?.currentTarget;\n      if (btn) {\n        const old = btn.innerText;\n        btn.innerText = 'âœ…';\n        setTimeout(() => { btn.innerText = old; }, 1000);\n      }\n    }\n    async function copyGenResult() {\n      const txt = document.getElementById('genOutput').innerText;\n      await navigator.clipboard.writeText(txt);\n      showModal({ title: 'å¤åˆ¶æˆåŠŸ', message: 'å·²å°†æ‰€æœ‰æ¿€æ´»ç å­˜å…¥å‰ªè´´æ¿', type: 'alert' });\n    }\n\n    async function exportData() {\n      if (ALL_LICENSES.length === 0) return showModal({ title: 'æç¤º', message: 'å½“å‰æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®', type: 'alert' });\n      const dataStr = JSON.stringify(ALL_LICENSES, null, 2);\n      const blob = new Blob([dataStr], { type: 'application/json' });\n      const url = URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = 'hw-licenses-backup-' + Date.now() + '.json';\n      document.body.appendChild(a);\n      a.click();\n      document.body.removeChild(a);\n      URL.revokeObjectURL(url);\n    }\n\n    // å¯¼å‡ºä¸ºé€‚åˆ Excel æ‰“å¼€çš„ CSV æ ¼å¼è¡¨æ ¼\n    async function exportExcel() {\n      if (ALL_LICENSES.length === 0) return showModal({ title: 'æç¤º', message: 'å½“å‰æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®', type: 'alert' });\n\n      // 1. æ„å»º CSV è¡¨å¤´\n      let csvContent = 'æ¿€æ´»ç æ ‡è¯†,ç»‘å®šç”¨æˆ·/å¤‡æ³¨,çŠ¶æ€,è®¾å¤‡é…é¢,å·²åˆ†é…è®¾å¤‡,åŒ…å«äº§å“æ•°,è®¢é˜…è¯¦æƒ…æ‘˜è¦,åˆ›å»ºæ—¶é—´\\n';\n\n      // 2. éå†æ•°æ®å¹³é“ºé™ç»´\n      ALL_LICENSES.forEach(lic => {\n        // å¤„ç†å¯èƒ½åŒ…å«é€—å·çš„å­—æ®µï¼Œç”¨å¼•å·åŒ…è£¹\n        const safeStr = (str) => '\"' + (str ? String(str).replace(/\"/g, '\"\"') : '') + '\"';\n\n        // åˆå¹¶è®¢é˜…è¯¦æƒ…ä¸ºä¸€ä¸ªæ˜“è¯»çš„å­—ç¬¦ä¸²\n        const subDigest = (lic.subscriptions || []).map(s => {\n          const expStr = s.expires_at ? new Date(s.expires_at).toLocaleDateString() : 'æ°¸ä¹…';\n          return '[' + s.product_id + ': ' + expStr + ']';\n        }).join(' | ');\n\n        const row = [\n          safeStr(lic.license_key),\n          safeStr(lic.user_name || 'æœªé…ç½®'),\n          lic.status === 'revoked' ? 'å·²åŠé”€' : 'æ´»è·ƒ',\n          lic.max_devices,\n          lic.current_devices,\n          (lic.subscriptions || []).length,\n          safeStr(subDigest),\n          safeStr(new Date(lic.created_at).toLocaleString())\n        ];\n        csvContent += row.join(',') + '\\n';\n      });\n\n      // 3. åŠ ä¸Š UTF-8 BOMï¼Œé˜²æ­¢ Windows ä¸‹ Excel æ‰“å¼€ç›´æ¥ä¹±ç \n      const blob = new Blob(['\\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });\n      const url = URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = 'hw-licenses-report-' + Date.now() + '.csv';\n      document.body.appendChild(a);\n      a.click();\n      document.body.removeChild(a);\n      URL.revokeObjectURL(url);\n    }\n\n    async function importData(event) {\n      const file = event.target.files[0];\n      if (!file) return;\n      event.target.value = '';\n\n      const isCSV = file.name.toLowerCase().endsWith('.csv');\n\n      const reader = new FileReader();\n      reader.onload = async (e) => {\n        try {\n          const contentStr = e.target?.result;\n          let licenses = [];\n\n          if (isCSV) {\n            // CSV è§£æå¼•æ“\n            const rows = [];\n            let cur = '';\n            let inQuote = false;\n            for (let i = 0; i < contentStr.length; i++) {\n              const c = contentStr[i];\n              if (c === '\"') {\n                if (inQuote && contentStr[i + 1] === '\"') {\n                  cur += '\"';\n                  i++; // skip escaped quote\n                } else {\n                  inQuote = !inQuote;\n                }\n              } else if (c === ',' && !inQuote) {\n                rows.push(cur);\n                cur = '';\n              } else if ((c === '\\n' || c === '\\r') && !inQuote) {\n                if (c === '\\r' && contentStr[i + 1] === '\\n') i++; // CRLF\n                rows.push(cur);\n                if (rows.length > 1 || rows[0] !== '') {\n                  // Skip header row if it contains 'æ¿€æ´»ç æ ‡è¯†'\n                  if (!(rows.length > 0 && String(rows[0]).includes('æ¿€æ´»ç æ ‡è¯†'))) {\n                    // é€†å‘æ˜ å°„\n                    const key = rows[0]?.trim();\n                    if (key) {\n                      const userName = rows[1]?.trim();\n                      const status = rows[2]?.trim() === 'å·²åŠé”€' ? 'revoked' : 'active';\n                      const maxDev = parseInt(rows[3]) || 2;\n\n                      // æå– subscriptions digest (åˆ— 6: e.g., \"[smartmp: 2024/01/01] | [other: æ°¸ä¹…]\")\n                      const subDigest = rows[6] || '';\n                      const subs = [];\n                      const subRegex = /\\\\[(.*?) ?: ?(.*?)\\\\]/g;\n                      let match;\n                      while ((match = subRegex.exec(subDigest)) !== null) {\n                        const pId = match[1].trim();\n                        const expVal = match[2].trim();\n                        let expDate = null;\n                        if (expVal !== 'æ°¸ä¹…' && expVal !== 'æœªçŸ¥') {\n                          const parsed = new Date(expVal);\n                          if (!isNaN(parsed.getTime())) {\n                            expDate = parsed.toISOString();\n                          }\n                        }\n                        subs.push({ product_id: pId, expires_at: expDate });\n                      }\n\n                      licenses.push({\n                        license_key: key,\n                        user_name: userName === 'æœªé…ç½®' ? '' : userName,\n                        status: status,\n                        max_devices: maxDev,\n                        subscriptions: subs\n                      });\n                    }\n                  }\n                }\n                rows.length = 0;\n                cur = '';\n              } else {\n                cur += c;\n              }\n            }\n            if (cur || rows.length) {\n              rows.push(cur);\n              if (rows.length > 0 && rows[0]?.trim() && !String(rows[0]).includes('æ¿€æ´»ç æ ‡è¯†')) {\n                // Copy pasted mapping\n                const key = rows[0]?.trim();\n                if (key) {\n                  const userName = rows[1]?.trim();\n                  const status = rows[2]?.trim() === 'å·²åŠé”€' ? 'revoked' : 'active';\n                  const maxDev = parseInt(rows[3]) || 2;\n                  const subDigest = rows[6] || '';\n                  const subs = [];\n                  const subRegex = /\\\\[(.*?) ?: ?(.*?)\\\\]/g;\n                  let match;\n                  while ((match = subRegex.exec(subDigest)) !== null) {\n                    const pId = match[1].trim();\n                    const expVal = match[2].trim();\n                    let expDate = null;\n                    if (expVal !== 'æ°¸ä¹…' && expVal !== 'æœªçŸ¥') {\n                      const parsed = new Date(expVal);\n                      if (!isNaN(parsed.getTime())) {\n                        expDate = parsed.toISOString();\n                      }\n                    }\n                    subs.push({ product_id: pId, expires_at: expDate });\n                  }\n                  licenses.push({\n                    license_key: key,\n                    user_name: userName === 'æœªé…ç½®' ? '' : userName,\n                    status: status,\n                    max_devices: maxDev,\n                    subscriptions: subs\n                  });\n                }\n              }\n            }\n            if (licenses.length === 0) throw new Error(\"CSV æ•°æ®ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®\");\n\n          } else {\n            // JSON å¯¼å…¥å¤„ç†\n            licenses = JSON.parse(contentStr);\n            if (!Array.isArray(licenses)) throw new Error(\"æ ¼å¼é”™è¯¯ï¼Œé JSON æ•°ç»„ï¼\");\n          }\n\n          const confirmed = await showModal({\n            title: 'æ‰¹é‡å¯¼å…¥ç¡®è®¤',\n            message: `å³å°†æ‰¹é‡å¯¼å…¥ ${licenses.length} æ¡æ•°æ®ï¼Œå·²å­˜åœ¨çš„æ•°æ®å°†ä¼šè¢«èåˆè¦†ç›–ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ`,\n            confirmText: 'ç¡®è®¤å¯¼å…¥',\n            danger: true\n          });\n          if (!confirmed) return;\n\n          // ä½¿ç”¨é®ç½©é˜²æ­¢äºŒæ¬¡ç‚¹å‡»\n          const btn = document.querySelector('.modal-footer .primary');\n          if (btn) btn.innerText = \"ä¸Šä¼ ä¸­...\";\n\n          const fRes = await fetch('/api/v1/auth/admin/licenses/import', {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + ADMIN_SECRET },\n            body: JSON.stringify({ licenses })\n          });\n\n          const data = await fRes.json();\n          if (data.success) {\n            showToast('å¯¼å…¥æˆåŠŸï¼š' + data.msg, 'success');\n            loadLicenses();\n          } else {\n            showToast('å¯¼å…¥å¤±è´¥ï¼š' + data.msg, 'error');\n          }\n        } catch (err) {\n          showToast('è§£æé”™è¯¯ï¼š' + err.message, 'error');\n        }\n      };\n      reader.readAsText(file);\n    }\n\n    // ==========================================\n    // æ‰¹é‡æ“ä½œé€»è¾‘\n    // ==========================================\n    function updateBatchBar() {\n      const bar = document.getElementById('batchBar');\n      const countDisplay = document.getElementById('batchCountDisplay');\n      if (!bar || !countDisplay) return;\n      const count = SET_SELECTED_KEYS.size;\n      countDisplay.innerText = count + ' é¡¹é€‰ä¸­';\n      if (count > 0) {\n        bar.classList.add('active');\n      } else {\n        bar.classList.remove('active');\n      }\n    }\n\n    function toggleBatchItem(key, isChecked) {\n      if (isChecked) {\n        SET_SELECTED_KEYS.add(key);\n      } else {\n        SET_SELECTED_KEYS.delete(key);\n      }\n      updateBatchBar();\n    }\n\n    function toggleAllCheckboxes(checkboxElem) {\n      const isChecked = checkboxElem.checked;\n      document.querySelectorAll('.row-checkbox').forEach(cb => {\n        cb.checked = isChecked;\n        if (isChecked) {\n          SET_SELECTED_KEYS.add(cb.value);\n        } else {\n          SET_SELECTED_KEYS.delete(cb.value);\n        }\n      });\n      updateBatchBar();\n    }\n\n    function clearBatchSelection() {\n      SET_SELECTED_KEYS.clear();\n      document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = false);\n      const headerCb = document.querySelector('.lic-header .custom-checkbox');\n      if (headerCb) headerCb.checked = false;\n      updateBatchBar();\n    }\n\n    // å…¨é€‰å½“å‰ç­›é€‰ç»“æœ\n    function selectAllFiltered() {\n      const kw = document.getElementById('keywordSearch').value.toLowerCase();\n      const pId = document.getElementById('filterProductId').value;\n\n      let filtered = ALL_LICENSES.filter(l => {\n        const matchKeyword = !kw ||\n          l.license_key.toLowerCase().includes(kw) ||\n          (l.user_name && l.user_name.toLowerCase().includes(kw));\n        const matchProduct = !pId || l.product_id === pId;\n        let matchStatus = true;\n        if (currentStatusFilter === 'active') matchStatus = l.status === 'active';\n        else if (currentStatusFilter === 'revoked') matchStatus = l.status === 'revoked';\n        return matchKeyword && matchProduct && matchStatus;\n      });\n\n      filtered.forEach(l => SET_SELECTED_KEYS.add(l.license_key));\n      filterLocalList(false); // è§¦å‘é‡æ–°æ¸²æŸ“ä»¥å›æ˜¾å‹¾é€‰\n      updateBatchBar();\n      showToast(`å·²å…¨é€‰å½“å‰è§†å›¾ä¸‹çš„ ${filtered.length} ä¸ªç»“æœã€‚`, 'success');\n    }\n\n    // æç®€åŒ–çš„æ‰¹é‡æ‰§è¡Œæµç¨‹ï¼ˆé›¶åŠ¨ç”»ã€æ— é˜»å¡æç¤ºå“åº”ï¼‰\n    async function executeBatch() {\n      const actionSelect = document.getElementById('batchActionSelect');\n      const action = actionSelect ? actionSelect.value : '';\n      if (!action) {\n        showToast('è¯·å…ˆé€‰æ‹©éœ€è¦æ‰§è¡Œçš„æ‰¹é‡åŠ¨ä½œ', 'warning');\n        return;\n      }\n\n      const keys = Array.from(SET_SELECTED_KEYS);\n      if (keys.length === 0) {\n        showToast('è¯·å…ˆå‹¾é€‰è‡³å°‘ä¸€å¼ å¡å¯†', 'warning');\n        return;\n      }\n\n      // å‰ç«¯çº¯æ–‡å­—æå–\n      if (action === 'copy_keys') {\n        try {\n          await navigator.clipboard.writeText(keys.join('\\n'));\n          showToast(`å·²å¤åˆ¶ ${keys.length} ä¸ªæ¿€æ´»ç åˆ°å‰ªè´´æ¿ï¼`, 'success');\n          clearBatchSelection();\n        } catch (e) {\n          showToast('å¤åˆ¶å¤±è´¥ï¼Œæ‚¨çš„æµè§ˆå™¨å¯èƒ½é˜»æ‹¦äº†å‰ªè´´æ¿è®¿é—®ã€‚', 'error');\n        }\n        return;\n      }\n\n      const optionText = actionSelect.options[actionSelect.selectedIndex].text.replace(/^[\\u0000-\\uFFFF]{1,3}\\s/, '');\n      const confirmed = await showModal({\n        title: 'æ‰¹é‡æ“ä½œç¡®è®¤',\n        message: `ğŸš€ æœ€ç»ˆç¡®è®¤ï¼šæ˜¯å¦å¯¹ ${keys.length} ä¸ªå¡å¯†æ‰§è¡Œ [${optionText}] æ“ä½œï¼Ÿ`,\n        confirmText: 'ç¡®å®šæ‰§è¡Œ',\n        danger: true\n      });\n      if (!confirmed) return;\n\n      let params = {};\n\n      if (action === 'set_user_name') {\n        const res = await showModal({\n          title: 'ä¿®æ”¹å¤‡æ³¨',\n          inputs: [{ label: `å¯¹ ${keys.length} ä¸ªå¡å¯†ä¿®æ”¹å¤‡æ³¨ä¸ºï¼š`, value: '', placeholder: 'è¾“å…¥æ–°å¤‡æ³¨' }],\n          confirmText: 'ç¡®å®š'\n        });\n        if (!res) return;\n        params.user_name = res[0] || '';\n      } else if (action === 'set_max_devices') {\n        const res = await showModal({\n          title: 'ä¿®æ”¹è®¾å¤‡ä¸Šé™',\n          inputs: [{ label: `è°ƒæ•´ ${keys.length} ä¸ªå¡å¯†çš„è®¾å¤‡ä¸Šé™ (1-1000)ï¼š`, value: '2', type: 'number' }],\n          confirmText: 'ç¡®å®š'\n        });\n        if (!res) return;\n        params.max_devices = parseInt(res[0]) || 1;\n      } else if (action === 'add_subscription') {\n        const res = await showModal({\n          title: 'ç»­è´¹/åŠ äº§å“',\n          inputs: [\n            { label: 'äº§å“è¯†åˆ« ID (ä¾‹å¦‚ smartmp)ï¼š', value: '', placeholder: 'å¦‚ smartmp' },\n            { label: 'æœ‰æ•ˆå¤©æ•° (ç•™ç©ºè¡¨ç¤ºæ°¸ä¹…)ï¼š', value: '365', type: 'number' }\n          ],\n          confirmText: 'ç¡®å®š'\n        });\n        if (!res || !res[0]) return;\n        params.product_id = res[0];\n        params.duration_days = res[1] ? parseInt(res[1]) : null;\n      } else if (action === 'remove_subscription') {\n        const res = await showModal({\n          title: 'å‰¥å¤ºæŒ‡å®šäº§å“æƒé™',\n          inputs: [{ label: 'è¦å‰¥å¤ºæƒé™çš„äº§å“ IDï¼š', value: '', placeholder: 'å¦‚ smartmp' }],\n          confirmText: 'ç¡®å®š',\n          danger: true\n        });\n        if (!res || !res[0]) return;\n        params.product_id = res[0];\n      }\n\n      try {\n        const res = await fetch('/api/v1/auth/admin/licenses/batch', {\n          method: 'POST',\n          headers: {\n            'Authorization': 'Bearer ' + ADMIN_SECRET,\n            'Content-Type': 'application/json'\n          },\n          body: JSON.stringify({ keys, action, params })\n        });\n        const data = await res.json();\n\n        if (data.success) {\n          clearBatchSelection();\n          showToast(data.msg, 'success');\n          loadLicenses();\n        } else {\n          showToast('æ‰§è¡Œå¤±è´¥ï¼š' + data.msg, 'error');\n        }\n      } catch (err) {\n        showToast('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼š' + (err.message || err), 'error');\n      }\n    }\n\n    // ==========================================\n    // è®¾å¤‡æ˜ç»†é¢æ¿æ§åˆ¶ (é›¶åŠ¨ç”»ç²¾ç®€ç‰ˆ)\n    // ==========================================\n    async function toggleDevicePanel(key) {\n      const panel = document.getElementById('devicePanel_' + key);\n      if (!panel) return;\n\n      if (panel.style.display === 'block') {\n        panel.style.display = 'none';\n        return;\n      }\n\n      panel.style.display = 'block';\n      panel.innerHTML = '<div style=\"color:var(--text-main); font-size:12px; padding:10px;\">âŒ› åŠ è½½ä¸­...</div>';\n\n      try {\n        const res = await fetch('/api/v1/auth/admin/licenses/' + key + '/devices', {\n          headers: { 'Authorization': 'Bearer ' + ADMIN_SECRET }\n        });\n        const data = await res.json();\n\n        if (!data.success) {\n          panel.innerHTML = '<div style=\"color:var(--danger); font-size:12px;\">âŒ åŠ è½½å¤±è´¥: ' + data.msg + '</div>';\n          return;\n        }\n\n        const devices = data.data;\n        if (devices.length === 0) {\n          panel.innerHTML = '<div style=\"color:var(--text-main); font-size:12px;\">ğŸ“­ æš‚æ— ç»‘å®šè®¾å¤‡ã€‚</div>';\n          return;\n        }\n\n        // è¶…æç®€è¡¨æ ¼æ›¿ä»£å¤æ‚çš„è¡¨æ ¼æ¡†æ¶ç»“æ„ä»¥é™ä½èŠ‚ç‚¹é‡\n        let html = `<div style=\"padding:8px 12px; font-size:12px;\"><strong>å…±è®¡ ${devices.length} å°åœ¨çº¿è®¾å¤‡ï¼š</strong></div>`;\n        devices.forEach(d => {\n          const lActive = d.last_active ? new Date(d.last_active + 'Z').toLocaleString('zh-CN') : 'æœªçŸ¥';\n          html += `\n            <div style=\"padding:8px 12px; border-top:1px solid #30363d; font-size:12px; display:flex; justify-content:space-between; align-items:center;\">\n              <div>\n                <div style=\"color:var(--text-bright); margin-bottom:4px;\"><strong>${d.device_name || 'æœªå‘½åè®¾å¤‡'}</strong></div>\n                <div style=\"font-family:monospace; color:var(--text-main); margin-bottom:2px;\">${d.device_id}</div>\n                <div style=\"color:var(--text-main); font-size:11px;\">æœ€ååœ¨çº¿: ${lActive}</div>\n              </div>\n              <button class=\"secondary\" style=\"padding:6px 10px; font-size:12px; color:var(--danger);\" onclick=\"removeSingleDevice('${key}', '${d.device_id}')\">å¼ºåˆ¶è§£ç»‘</button>\n            </div>\n          `;\n        });\n\n        panel.innerHTML = html;\n\n      } catch (err) {\n        panel.innerHTML = '<div style=\"color:var(--danger); font-size:12px;\">âŒ æ— æ³•å­˜å–è®¾å¤‡æ•°æ®</div>';\n      }\n    }\n\n    async function removeSingleDevice(key, deviceId) {\n      const confirmed = await showModal({\n        title: 'å¼ºåˆ¶è§£ç»‘è®¾å¤‡',\n        message: 'ç¡®å®šè¦å¼ºåˆ¶æ³¨é”€è¯¥è®¾å¤‡å—ï¼Ÿè¸¢å‡ºåï¼Œç‰¹å®šå®¢æˆ·ç«¯å°†å¤±å»æˆæƒç½‘ç»œã€‚',\n        confirmText: 'ç¡®è®¤æ³¨é”€',\n        danger: true\n      });\n      if (!confirmed) return;\n\n      try {\n        const res = await fetch('/api/v1/auth/admin/licenses/' + key + '/devices/' + encodeURIComponent(deviceId), {\n          method: 'DELETE',\n          headers: { 'Authorization': 'Bearer ' + ADMIN_SECRET }\n        });\n        const data = await res.json();\n        if (data.success) {\n          toggleDevicePanel(key);\n          setTimeout(() => toggleDevicePanel(key), 300);\n          loadLicenses();\n        } else {\n          showToast('æ“ä½œå¤±è´¥: ' + data.msg, 'error');\n        }\n      } catch (err) {\n        showToast('ç½‘ç»œé”™è¯¯: ' + err.message, 'error');\n      }\n    }\n\n    // ==========================================\n    // é«˜çº§åŠŸèƒ½ï¼šé”®ç›˜å¿«æ·é”®æ”¯æŒ\n    // ==========================================\n    document.addEventListener('keydown', (e) => {\n      // Ctrl/Cmd + K: èšç„¦å…¨å±€æœç´¢\n      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') {\n        e.preventDefault();\n        const searchInput = document.getElementById('keywordSearch');\n        if (searchInput) searchInput.focus();\n      }\n\n      // Ctrl/Cmd + R: æ— åŠ¨ç”»é™é»˜åˆ·æ–°æ•°æ®åˆ—è¡¨\n      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'r' && !e.shiftKey) {\n        e.preventDefault();\n        loadLicenses();\n      }\n\n      // Esc: æ”¶èµ·ç›®å‰æ‰“å¼€çš„æ‰€æœ‰æ¨¡æ€æ¡†/ä¸‹æ‹‰é¢æ¿\n      if (e.key === 'Escape') {\n        closeModal();\n      }\n    });\n  </script>\n</body>\n\n</html>";