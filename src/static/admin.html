<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>äº’ä¸ºå¡å¯†ä¸­å¿ƒ - å¼€å‘è€…æ§åˆ¶å° </title>
  <style>
    :root {
      --bg-color: #0d1117;
      --panel-bg: #161b22;
      --card-bg: #21262d;
      --border-color: #30363d;
      --text-main: #8b949e;
      --text-bright: #c9d1d9;
      --accent: #58a6ff;
      --accent-glow: rgba(88, 166, 255, 0.15);
      --success: #3fb950;
      --warning: #d29922;
      --danger: #f85149;
      --indigo: #5385ff;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
      background: var(--bg-color);
      color: var(--text-bright);
      line-height: 1.6;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 40px 20px;
    }

    /* Header & Stats */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 30px;
    }

    .header-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-title h1 {
      font-size: 20px;
      font-weight: 600;
      margin: 0;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--panel-bg);
      border: 1px solid var(--border-color);
      padding: 20px;
      border-radius: 12px;
    }

    .stat-label {
      font-size: 13px;
      color: var(--text-main);
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      border-bottom: 1px solid var(--border-color);
    }

    .tab {
      padding: 12px 20px;
      cursor: pointer;
      color: var(--text-main);
      font-weight: 500;
      border-bottom: 2px solid transparent;
      transition: 0.2s;
      position: relative;
    }

    .tab:hover {
      color: var(--text-bright);
    }

    .tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    /* Forms & Inputs */
    .card {
      background: var(--panel-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 8px;
      color: var(--text-main);
    }

    input,
    select {
      width: 100%;
      padding: 10px 12px;
      background: #0d1117;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-bright);
      outline: none;
      transition: 0.2s;
      box-sizing: border-box;
    }

    input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }

    button {
      padding: 10px 20px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.2s;
      border: 1px solid transparent;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    button.primary {
      background: var(--indigo);
      color: white;
    }

    button.primary:hover {
      opacity: 0.9;
    }

    button.secondary {
      background: #21262d;
      border-color: var(--border-color);
      color: var(--text-bright);
    }

    button.secondary:hover {
      background: #30363d;
    }

    button.danger {
      background: transparent;
      color: var(--danger);
      border-color: var(--danger);
    }

    button.danger:hover {
      background: var(--danger);
      color: white;
    }

    /* List Layout for Licenses */
    .lic-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 10px;
    }

    .lic-row {
      background: var(--panel-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 12px 16px;
      display: grid;
      grid-template-columns: 2fr 3fr 1fr 150px;
      gap: 16px;
      align-items: center;
      transition: 0.2s;
    }

    .lic-row:hover {
      border-color: var(--accent);
      background: #1c2128;
    }

    .lic-header {
      display: grid;
      grid-template-columns: 2fr 3fr 1fr 150px;
      gap: 16px;
      padding: 0 16px 10px 16px;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-main);
    }

    @media(max-width: 800px) {
      .lic-row {
        grid-template-columns: 1fr;
        align-items: start;
      }

      .lic-header {
        display: none;
      }
    }

    .badge {
      padding: 2px 8px;
      border-radius: 2em;
      font-size: 12px;
      font-weight: 600;
    }

    .badge-success {
      background: rgba(63, 185, 80, 0.1);
      color: var(--success);
      border: 1px solid rgba(63, 185, 80, 0.2);
    }

    .badge-warning {
      background: rgba(210, 153, 34, 0.1);
      color: var(--warning);
      border: 1px solid rgba(210, 153, 34, 0.2);
    }

    .badge-danger {
      background: rgba(248, 81, 73, 0.1);
      color: var(--danger);
      border: 1px solid rgba(248, 81, 73, 0.2);
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      backdrop-filter: blur(4px);
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: var(--panel-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 24px;
      width: 400px;
      max-width: 90vw;
    }

    .modal-header {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--text-bright);
    }

    .modal-body {
      margin-bottom: 24px;
      color: var(--text-main);
      font-size: 14px;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    /* Auth Overlay */
    #adminAuth {
      position: fixed;
      inset: 0;
      background: var(--bg-color);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .login-card {
      width: 340px;
      padding: 32px;
      background: var(--panel-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      text-align: center;
    }

    /* Custom Dropdown */
    .dropdown-container {
      position: relative;
      width: 100%;
    }

    .custom-dropdown {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      right: 0;
      background: var(--panel-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      z-index: 100;
      max-height: 240px;
      overflow-y: auto;
      display: none;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
    }

    .custom-dropdown.active {
      display: block;
      animation: dropDownFade 0.2s ease-out;
    }

    @keyframes dropDownFade {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .dropdown-item {
      padding: 10px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      font-size: 13px;
      transition: 0.2s;
    }

    .dropdown-item:hover {
      background: #1c2128;
      color: var(--accent);
    }

    .dropdown-item.remove-btn {
      opacity: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      color: var(--text-main);
      transition: 0.2s;
    }

    .dropdown-item:hover .remove-btn {
      opacity: 1;
    }

    .dropdown-item.remove-btn:hover {
      background: rgba(248, 81, 73, 0.1);
      color: var(--danger);
    }

    .custom-dropdown::-webkit-scrollbar {
      width: 6px;
    }

    .custom-dropdown::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 10px;
    }

    /* åˆ†é¡µæ§ä»¶æ ·å¼ */
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      margin-top: 24px;
      padding: 16px 0;
      border-top: 1px solid var(--border-color);
    }

    .pagination button {
      padding: 6px 14px;
      font-size: 13px;
    }

    .pagination .page-info {
      font-size: 13px;
      color: var(--text-main);
      background: var(--card-bg);
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid var(--border-color);
    }

    /* æ‰¹é‡æ“ä½œæ‚¬æµ®æ¡ */
    .batch-bar {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--panel-bg);
      border: 1px solid var(--border-color);
      padding: 12px 24px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      display: flex;
      gap: 12px;
      align-items: center;
      transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      opacity: 0;
      pointer-events: none;
      z-index: 100;
    }

    .batch-bar.active {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
      pointer-events: auto;
    }

    .batch-bar button {
      padding: 6px 12px;
      font-size: 13px;
    }

    .batch-count {
      background: var(--accent);
      color: var(--bg-color);
      font-weight: bold;
      padding: 2px 8px;
      border-radius: 10px;
      margin-right: 12px;
    }

    .custom-checkbox {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    /* Toast */
    #toastContainer {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 3000;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: none;
    }

    .toast {
      background: var(--panel-bg);
      border: 1px solid var(--border-color);
      color: var(--text-bright);
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
      animation: toastIn 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28) forwards;
      pointer-events: auto;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .toast.success {
      border-left: 4px solid var(--success);
    }

    .toast.error {
      border-left: 4px solid var(--danger);
    }

    .toast.warning {
      border-left: 4px solid var(--warning);
    }

    @keyframes toastIn {
      0% {
        transform: translateX(120%);
        opacity: 0;
      }

      100% {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes toastOut {
      0% {
        transform: translateX(0);
        opacity: 1;
      }

      100% {
        transform: translateX(120%);
        opacity: 0;
      }
    }
  </style>

<body>

  <div id="appModal" class="modal-overlay">
    <div class="modal-content">
      <div id="modalTitle" class="modal-header"> æç¤º </div>
      <div id="modalBody" class="modal-body"> </div>
      <div id="modalInputs" class="form-grid" style="display:none; margin-bottom: 20px;"> </div>
      <div class="modal-footer">
        <button class="secondary" id="modalBtnCancel" onclick="closeModal()"> å–æ¶ˆ </button>
        <button class="primary" id="modalBtnConfirm"> ç¡®å®š </button>
      </div>
    </div>
  </div>

  <div id="adminAuth">
    <div class="login-card">
      <h2 style="margin-top:0; color:var(--text-bright)">ğŸ”‘ èº«ä»½éªŒè¯ </h2>
      <p style="color:var(--text-main); font-size:14px; margin-bottom:24px;"> è¾“å…¥ç®¡ç†å‘˜å¯†é’¥ä»¥è¿›å…¥æ§åˆ¶å° </p>
      <div class="form-group" style="text-align:left; position:relative;">
        <input type="password" id="globalSecret" placeholder="è¾“å…¥ Admin Secret..." value="" style="padding-right: 40px;">
        <span
          onclick="const i=document.getElementById('globalSecret');if(i.type==='password'){i.type='text';this.innerText='ğŸ™ˆ'}else{i.type='password';this.innerText='ğŸ‘ï¸'}"
          style="position:absolute; right:12px; top:50%; transform:translateY(-50%); cursor:pointer; opacity:0.6; user-select:none;">ğŸ‘ï¸</span>
      </div>
      <button class="primary" style="width:100%; margin-top:16px;" onclick="login()"> è¿›å…¥æ§åˆ¶å° </button>
    </div>
  </div>

  <div class="container">
    <div class="header">
      <div class="header-title">
        <div style="background:var(--indigo); padding:8px; border-radius:8px; display:flex;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"
            stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
            <path d="M7 11V7a5 5 0 0 1 10 0v4" />
          </svg>
        </div>
        <h1> äº’ä¸ºå¡å¯†ä¸­å¿ƒ </h1>
      </div>
      <div style="display:flex; gap:8px;">
        <button class="secondary" onclick="loadLicenses()">ğŸ”„ åˆ·æ–°åˆ—è¡¨ </button>
        <button class="secondary" onclick="logout()" style="color:var(--danger); border-color:rgba(255,100,100,0.3)">ğŸšª
          é€€å‡ºç™»å½• </button>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label"> æ€»å¡å¯†æ•°(Keys) </div>
        <div class="stat-value" id="stat-total"> -</div>
      </div>
      <div class="stat-card">
        <div class="stat-label"> æ´»è·ƒä¸­(Active) </div>
        <div class="stat-value" id="stat-active" style="color:var(--success)"> -</div>
      </div>
      <div class="stat-card">
        <div class="stat-label"> å·²åŠé”€(Revoked) </div>
        <div class="stat-value" id="stat-revoked" style="color:var(--danger)"> -</div>
      </div>
      <div class="stat-card">
        <div class="stat-label"> ä¸´æœŸ / å·²è¿‡æœŸ(Sub) </div>
        <div class="stat-value" id="stat-expiring" style="color:var(--warning)"> -</div>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" onclick="switchTab('generate')">âš¡ æé€Ÿç”Ÿå¡ </div>
      <div class="tab" onclick="switchTab('manage')">ğŸ› ï¸ èµ„äº§ç®¡ç† </div>
    </div>

    <!--Tab: Generate-->
    <div id="sec-generate" class="section active">
      <div class="card">
        <div class="form-grid">
          <div class="form-group">
            <label>äº§å“çº¿æ ‡è¯†(Product ID) </label>
            <div class="dropdown-container">
              <input type="text" id="genProductId" value="smartmp" placeholder="è¾“å…¥ ID æˆ–ç‚¹å‡»é€‰æ‹©å†å²è®°å½•" autocomplete="off"
                onfocus="showDropdown()" oninput="updateProductHelpers()">
              <div id="productDropdown" class="custom-dropdown"> </div>
            </div>
          </div>
          <div class="form-group">
            <label>ç»‘å®šç”¨æˆ·å / å¤‡æ³¨(å¯é€‰) </label>
            <input type="text" id="genUserName" placeholder="ä¾‹å¦‚: å®¢æˆ·åã€å†…éƒ¨è®¢å•å·...">
          </div>
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label>æ¿€æ´»ç è®¾å¤‡é…é¢(Max Devices) </label>
            <input type="number" id="genMaxDevices" value="2" min="1" oninput="updateGenInfo()">
          </div>
          <div class="form-group">
            <label>åˆå§‹è®¢é˜…æœ‰æ•ˆæœŸ(å¤©æ•°, ç•™ç©ºä¸ºæ°¸ä¹…) </label>
            <input type="number" id="genDuration" placeholder="ä¾‹å¦‚: 365, 30...">
          </div>
          <div class="form-group">
            <label>æ‰¹é‡ç”Ÿæˆæ•°é‡ </label>
            <div style="display:flex; gap:8px; margin-bottom:4px;">
              <input type="number" id="genCount" value="1" min="1" max="100" style="flex:1;" oninput="updateGenInfo()">
              <button class="secondary" onclick="setGenPreset(1,2,'')"
                style="padding:4px 8px; font-size:13px;">Ã—1</button>
              <button class="secondary" onclick="setGenPreset(5,2,'365')"
                style="padding:4px 8px; font-size:13px;">Ã—5/1å¹´</button>
              <button class="secondary" onclick="setGenPreset(10,1,'365')"
                style="padding:4px 8px; font-size:13px;">Ã—10/1å¹´</button>
            </div>
            <div id="genInfo" style="font-size:12px; color:var(--text-main); margin-top:4px;">
              å ç”¨é…é¢ï¼š2å° (1ä¸ªå¡å¯† Ã— 2è®¾å¤‡)
            </div>
          </div>
        </div>
        <button class="primary" id="btnDoGen" onclick="doGenerate()" style="width:100%; margin-top:10px;">âœ¨ ç«‹å³åˆ¶å¡å¹¶æ¿€æ´»è®¢é˜…
        </button>

        <div id="genResult"
          style="display:none; margin-top:24px; padding-top:24px; border-top:1px dashed var(--border-color);">
          <label style="color:var(--success); font-weight:600; margin-bottom:12px; display:block;">âœ… ç”ŸæˆæˆåŠŸï¼Œè¯·å¤åˆ¶ä¿å­˜ï¼š</label>
          <div id="genOutput"
            style="background:#0d1117; padding:16px; border-radius:8px; font-family:monospace; font-size:13px; margin-bottom:16px; white-space:pre-wrap; border:1px solid var(--border-color); color:var(--success);">
          </div>
          <div style="display:flex; gap:8px;">
            <button class="secondary" style="flex:2;" onclick="copyGenResult()">ğŸ“‹ å¤åˆ¶çº¯å¡å¯†æ–‡æœ¬ </button>
            <button class="primary" style="flex:1;" onclick="switchTab('manage')">ğŸ‘€ æŸ¥çœ‹ç®¡ç†åˆ—è¡¨ </button>
          </div>
        </div>
      </div>
    </div>

    <!--Tab: Manage-->
    <div id="sec-manage" class="section">
      <div class="search-bar" style="display:flex; flex-wrap:wrap; gap:12px; align-items:center;">
        <div class="search-input-wrap" style="flex:1; min-width:200px; max-width:300px;">
          <input type="text" id="keywordSearch" placeholder="æœç´¢å¡å¯†ã€ç”¨æˆ·å (Ctrl+K)" oninput="debounceSearch()">
        </div>

        <!-- å¿«é€ŸçŠ¶æ€ç­›é€‰ -->
        <div style="display:flex; gap:4px; margin-left:8px;" id="statusFilterGroup">
          <button class="secondary" onclick="filterStatus('all', this)"
            style="padding:4px 8px; font-size:12px; background:var(--accent); color:#fff;">å…¨éƒ¨</button>
          <button class="secondary" onclick="filterStatus('active', this)"
            style="padding:4px 8px; font-size:12px;">æ´»è·ƒ</button>
          <button class="secondary" onclick="filterStatus('revoked', this)"
            style="padding:4px 8px; font-size:12px;">å·²åŠé”€</button>
        </div>

        <div style="display:flex; gap:8px; margin-left:auto; align-items:center;">
          <!-- æ’åº -->
          <select id="sortOrder" onchange="applySort()"
            style="padding:6px; font-size:12px; border-radius:6px; background:#0d1117; color:var(--text-bright); border:1px solid var(--border-color); width:auto;">
            <option value="created_desc">æœ€æ–°ç”Ÿæˆâ†“</option>
            <option value="created_asc">æœ€æ—©ç”Ÿæˆâ†‘</option>
            <option value="devices_desc">é…é¢æœ€é«˜â†“</option>
          </select>

          <!-- äº§å“ç­›é€‰ -->
          <select id="filterProductId" onchange="loadLicenses()"
            style="padding:6px; font-size:12px; border-radius:6px; background:#0d1117; color:var(--text-bright); border:1px solid var(--border-color); width:auto; max-width:180px;">
            <option value=""> æ‰€æœ‰äº§å“çº¿(Show All) </option>
          </select>
        </div>

        <div style="display:flex; width:100%; justify-content:space-between; align-items:center; margin-top:8px;">
          <div style="display:flex; gap:8px;">
            <button class="secondary" onclick="exportData()" style="padding:4px 8px; font-size:12px;">ğŸ“¤ å¯¼å‡ºJSON</button>
            <button class="secondary" onclick="exportExcel()" style="padding:4px 8px; font-size:12px;">ğŸ“Š
              å¯¼å‡ºExcel(CSV)</button>
            <button class="secondary" onclick="document.getElementById('importFile').click()"
              style="padding:4px 8px; font-size:12px;">ğŸ“¥ å¯¼å…¥é…ç½®/CSV</button>
            <input type="file" id="importFile" accept=".json,.csv" style="display:none" onchange="importData(event)">
          </div>
          <div id="topPagination"></div>
        </div>
      </div>

      <!--é˜¶æ®µä¸€äºŒè¿‡æ¸¡ï¼šæš‚æ—¶ä¿ç•™ table å®¹å™¨åï¼Œä»¥ä¾¿ JS è¿˜èƒ½å¡«å……æ•°æ®ï¼Œä¸‹ä¸€é˜¶æ®µå°†å½»åº•æ”¹ä¸ºç½‘æ ¼å¡ç‰‡-->
      <div id="licListContainer">
        <div class="table-container">
          <table id="licTable">
            <thead>
              <tr>
                <th>æ¿€æ´»ç (Key) </th>
                <th> åŸºæœ¬ä¿¡æ¯ </th>
                <th> å½“å‰è®¢é˜… </th>
                <th> è®¾å¤‡ä½¿ç”¨ </th>
                <th> å¿«æ·æ“ä½œ </th>
              </tr>
            </thead>
            <tbody> </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- æ‰¹é‡æ“ä½œæ‚¬æµ®æ¡ -->
  <div class="batch-bar" id="batchBar" style="transition: none;">
    <div class="batch-count" id="batchCountDisplay">0</div>
    <select id="batchActionSelect"
      style="background:#0d1117; color:#c9d1d9; border:1px solid #30363d; border-radius:6px; padding:6px 12px; font-size:13px; outline:none;">
      <option value="" disabled selected>ğŸ‘‰ é€‰æ‹©æ‰¹é‡åŠ¨ä½œ...</option>
      <optgroup label="åŸºç¡€æ•°æ®">
        <option value="revoke">ğŸ”’ æ‰¹é‡åŠé”€</option>
        <option value="restore">ğŸ”“ æ‰¹é‡æ¢å¤</option>
        <option value="delete">ğŸ—‘ï¸ å½»åº•åˆ é™¤</option>
        <option value="set_user_name">ğŸ“ ä¿®æ”¹å¤‡æ³¨</option>
        <option value="copy_keys">ğŸ“‹ å¤åˆ¶çº¯å¡å¯†æ–‡æœ¬</option>
      </optgroup>
      <optgroup label="äº§å“ä¸è®¢é˜…">
        <option value="add_subscription">ğŸš€ ç»­è´¹/åŠ äº§å“</option>
        <option value="remove_subscription">âŒ æŠ½ç¦»ç‰¹å®šäº§å“</option>
      </optgroup>
      <optgroup label="è®¾å¤‡ç®¡ç†">
        <option value="unbind">ğŸ“± å¼ºåˆ¶è¸¢å‡ºè®¾å¤‡</option>
        <option value="set_max_devices">ğŸ”¢ ä¿®æ”¹ä¸Šçº¿é¢åº¦</option>
      </optgroup>
    </select>
    <button class="primary" style="padding:6px 16px" onclick="executeBatch()">ğŸš€ ç¡®å®šæ‰§è¡Œ</button>
    <button class="secondary" style="padding:6px 12px" onclick="selectAllFiltered()">â˜‘ï¸ å…¨é€‰ä¸‹æ–¹</button>
    <button class="secondary" style="padding:6px 12px" onclick="clearBatchSelection()">æ¸…ç©ºæ¡†é€‰</button>
  </div>

  <script>
    let ADMIN_SECRET = "";
    let ALL_LICENSES = []; // æœ¬åœ°æ•°æ®ç¼“å­˜
    let SET_SELECTED_KEYS = new Set(); // æ‰¹é‡é€‰ä¸­çš„ keys

    // åˆ†é¡µçŠ¶æ€
    let currentPage = 1;
    let PAGE_SIZE = 20;  // æ¯é¡µæ˜¾ç¤ºæ¡æ•°
    let PRODUCT_HISTORY = new Set(['smartmp']);

    let modalResolve = null;

    function showToast(message, type = 'success') {
      let container = document.getElementById('toastContainer');
      if (!container) {
        container = document.createElement('div');
        container.id = 'toastContainer';
        document.body.appendChild(container);
      }
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = message;
      container.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'toastOut 0.3s forwards';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    function showModal(options) {
      return new Promise(resolve => {
        document.getElementById('modalTitle').innerText = options.title || 'æç¤º';
        document.getElementById('modalBody').innerHTML = options.message || '';

        const inputsDiv = document.getElementById('modalInputs');
        inputsDiv.innerHTML = '';
        if (options.inputs) {
          inputsDiv.style.display = 'grid';
          let htmlInputs = '';
          options.inputs.forEach((inp, i) => {
            htmlInputs += '<div class="form-group"><label>' + inp.label + '</label><input type="' + (inp.type || 'text') + '" id="modalInp' + i + '" value="' + (inp.value || '') + '" placeholder="' + (inp.placeholder || '') + '"></div>';
          });
          inputsDiv.innerHTML = htmlInputs;
        } else {
          inputsDiv.style.display = 'none';
        }

        const confirmBtn = document.getElementById('modalBtnConfirm');
        confirmBtn.className = options.danger ? 'danger' : 'primary';
        confirmBtn.innerText = options.confirmText || 'ç¡®å®š';

        const cancelBtn = document.getElementById('modalBtnCancel');
        if (options.type === 'alert') {
          cancelBtn.style.display = 'none';
        } else {
          cancelBtn.style.display = 'inline-flex';
        }

        modalResolve = resolve;

        confirmBtn.onclick = () => {
          let result = true;
          if (options.inputs) {
            result = options.inputs.map((_, i) => document.getElementById('modalInp' + i).value);
          }
          closeModal(result);
        };

        document.getElementById('appModal').classList.add('active');
      });
    }

    function closeModal(result = false) {
      document.getElementById('appModal').classList.remove('active');
      if (modalResolve) modalResolve(result);
      modalResolve = null;
    }

    async function login() {
      const s = document.getElementById('globalSecret').value.trim();
      if (!s) {
        showToast('è¯·è¾“å…¥å¯†é’¥', 'warning');
        return;
      }

      const btn = document.querySelector('#adminAuth button');
      const originalText = btn.innerText;
      btn.disabled = true;
      btn.innerText = 'éªŒè¯ä¸­...';

      try {
        const res = await fetch('/api/v1/auth/admin/licenses?product_id=', {
          headers: { 'Authorization': 'Bearer ' + s }
        });

        if (!res.ok) {
          showToast('å¯†é’¥æ— æ•ˆï¼Œè¯·æ£€æŸ¥', 'error');
          throw new Error();
        }

        ADMIN_SECRET = s;
        localStorage.setItem('hw_admin_secret', s);
        document.getElementById('adminAuth').style.display = 'none';
        loadLicenses();
      } catch (e) {
        // è¯·æ±‚å¤±è´¥è‡ªåŠ¨æ¢å¤æŒ‰é’®çŠ¶æ€
        if (e.message !== '') {
          showToast('ç½‘ç»œæˆ–è¿æ¥å¼‚å¸¸: ' + e.message, 'error');
        } else {
          // ç”± response.ok !== true æŠ›å‡ºçš„ç©º Error
        }
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.innerText = originalText;
        }
      }
    }

    function logout() {
      ADMIN_SECRET = "";
      localStorage.removeItem('hw_admin_secret');
      document.getElementById('globalSecret').value = '';
      document.getElementById('adminAuth').style.display = 'flex';
      document.getElementById('licListContainer').innerHTML = '';
      ALL_LICENSES = [];
      updateStats();
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨å°è¯•ä»æœ¬åœ°ç¼“å­˜æ¢å¤ä¼šè¯
    window.addEventListener('DOMContentLoaded', () => {
      const savedSecret = localStorage.getItem('hw_admin_secret');
      if (savedSecret) {
        document.getElementById('globalSecret').value = savedSecret;
        login();
      }
    });

    // å›è½¦å¿«æ·ç™»å½•
    document.getElementById('globalSecret').onkeyup = (e) => { if (e.key === 'Enter') login(); };

    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      const target = (event && event.target) ? event.target : document.querySelector('.tab[onclick*="' + tab + '"]');
      if (target) target.classList.add('active');
      document.getElementById('sec-' + tab).classList.add('active');
      if (tab === 'manage') loadLicenses();
    }

    let currentPagination = null;
    let currentStats = null;

    // è®¡ç®—å¹¶æ›´æ–°é¡¶éƒ¨ç»Ÿè®¡æŒ‡æ ‡
    function updateStats(stats) {
      if (!stats) return;
      document.getElementById('stat-total').innerText = stats.total;
      document.getElementById('stat-active').innerText = stats.active;
      document.getElementById('stat-revoked').innerText = stats.revoked;
      document.getElementById('stat-expiring').innerText = stats.expiring;

      // ä¸ºä¸´æœŸçœ‹æ¿ç»‘å®šç‚¹å‡»ç­›é€‰èƒ½åŠ› (ä»…ç»‘å®šä¸€æ¬¡é˜²é‡å¤)
      const expCard = document.getElementById('stat-expiring').parentElement;
      expCard.style.cursor = 'pointer';
      if (!expCard.dataset.bound) {
        expCard.onmouseenter = () => expCard.style.border = '1px solid var(--warning)';
        expCard.onmouseleave = () => expCard.style.border = '1px solid var(--border-color)';
        expCard.onclick = () => {
          // æ¸…ç©ºå…¶ä»–é«˜äº®æŒ‰é’®
          document.querySelectorAll('#statusFilterGroup button').forEach(btn => {
            btn.style.background = '';
            btn.style.color = 'var(--text-bright)';
          });
          filterStatus('expiring', null);
        };
        expCard.dataset.bound = 'true';
      }
    }

    // æ˜¾ç¤º/éšè—ä¸‹æ‹‰æ¡†
    function showDropdown() {
      document.getElementById('productDropdown').classList.add('active');
      updateProductHelpers();
    }
    function hideDropdown() {
      setTimeout(() => {
        document.getElementById('productDropdown').classList.remove('active');
      }, 200); // å»¶è¿Ÿå…³é—­ä»¥ä¾¿æ•è·ç‚¹å‡»
    }

    // ä»å†å²è®°å½•ä¸­ç‰©ç†ç§»é™¤æŸä¸ªäº§å“ ID
    function removeFromHistory(e, id) {
      if (e) e.stopPropagation(); // é˜²æ­¢è§¦å‘é€‰æ‹©
      showModal({
        title: 'ç§»é™¤è®°å½•',
        message: 'ç¡®å®šä»å†å²å»ºè®®ä¸­ç§»é™¤ "' + id + '" å—ï¼Ÿ',
        confirmText: 'ç¡®å®šç§»é™¤',
        danger: true
      }).then(confirmed => {
        if (confirmed) {
          PRODUCT_HISTORY.delete(id);
          updateProductHelpers();
        }
      });
    }

    // ç”Ÿå¡åŒºé€‰æ‹©äº§å“ ID çš„è¾…åŠ©å‡½æ•°
    function setGenProduct(val) {
      document.getElementById('genProductId').value = val;
      updateProductHelpers();
      hideDropdown();
    }

    // æ›´æ–°äº§å“è¾…åŠ©å™¨ï¼ˆåŒ…æ‹¬ç­›é€‰ä¸‹æ‹‰å’Œè‡ªå®šä¹‰ç”Ÿå¡ä¸‹æ‹‰æ¡†ï¼‰
    function updateProductHelpers() {
      const filterSelect = document.getElementById('filterProductId');
      const dropdown = document.getElementById('productDropdown');
      const genInput = document.getElementById('genProductId');

      // 1. åŒæ­¥å½“å‰æ‰€æœ‰å­˜é‡äº§å“åˆ°å†å²åº“
      ALL_LICENSES.forEach(l => PRODUCT_HISTORY.add(l.product_id));

      // 2. æ›´æ–°ç®¡ç†åˆ—è¡¨ä¸Šæ–¹çš„â€œç­›é€‰â€ä¸‹æ‹‰æ¡†
      const currentFilter = filterSelect.value;
      filterSelect.innerHTML = '<option value="">æ‰€æœ‰äº§å“çº¿ (Show All)</option>';
      [...PRODUCT_HISTORY].sort().forEach(p => {
        const opt = document.createElement('option');
        opt.value = p; opt.innerText = p;
        filterSelect.appendChild(opt);
      });
      filterSelect.value = currentFilter;

      // 3. æ›´æ–°ç”Ÿå¡åŒºçš„â€œè‡ªå®šä¹‰æœç´¢ä¸‹æ‹‰æ¡†â€
      const searchVal = genInput.value.toLowerCase();
      const matches = [...PRODUCT_HISTORY].filter(p => !searchVal || p.toLowerCase().includes(searchVal)).sort();

      if (matches.length === 0) {
        dropdown.innerHTML = '<div style="padding:12px; font-size:12px; color:var(--text-main); text-align:center;">æœªæ‰¾åˆ°åŒ¹é…çš„å†å²è®°å½•</div>';
      } else {
        let listHtml = '';
        matches.forEach(p => {
          listHtml += `<div class="dropdown-item" onclick="setGenProduct('${p}')">` +
            `<span>${p}</span>` +
            `<div class="remove-btn" onclick="removeFromHistory(event, '${p}')" title="ä»å†å²ä¸­ç§»é™¤">âœ•</div>` +
            `</div>`;
        });
        dropdown.innerHTML = listHtml;
      }
    }

    // ç‚¹å‡»å¤–éƒ¨è‡ªåŠ¨å…³é—­ä¸‹æ‹‰
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.dropdown-container')) {
        document.getElementById('productDropdown').classList.remove('active');
      }
    });

    // åç«¯æ¸¸æ ‡åŠ è½½æ•°æ®
    async function loadLicenses() {
      const searchKw = document.getElementById('keywordSearch') ? document.getElementById('keywordSearch').value.trim() : '';
      const pId = document.getElementById('filterProductId') ? document.getElementById('filterProductId').value : '';
      const container = document.getElementById('licListContainer');

      const queryParams = new URLSearchParams({
        page: currentPage,
        limit: PAGE_SIZE,
        search: searchKw,
        product_id: pId,
        status: currentStatusFilter,
        sort: currentSort
      });

      // é›¶çŠ¶æ€æ—¶ç»™å¤§å ä½ç¬¦ï¼Œæœ‰æ•°æ®å¢é‡æ—¶ä½¿ç”¨è½»å¾®é€æ˜åº¦ä¿æŠ¤ä¹è§‚UI
      if (!document.querySelector('.lic-row')) {
        container.innerHTML = '<div style="text-align:center; padding:50px; color:var(--text-main)">ğŸš€ æ­£åœ¨åŒæ­¥è¾¹ç¼˜æ•°æ®...</div>';
      } else {
        container.style.opacity = '0.6';
      }

      try {
        const res = await fetch('/api/v1/auth/admin/licenses?' + queryParams.toString(), {
          headers: { 'Authorization': 'Bearer ' + ADMIN_SECRET }
        });
        const data = await res.json();

        container.style.opacity = '1';

        if (!data.success) {
          if (res.status === 401) {
            logout();
            showModal({ title: 'ä¼šè¯å¤±æ•ˆ', message: 'å¯†é’¥æ— æ•ˆæˆ–å·²æ›´æ”¹ï¼Œè¯·é‡æ–°è¾“å…¥', type: 'alert' });
            return;
          }
          container.innerHTML = '<div style="padding:20px; color:var(--danger)">âŒ è·å–å¤±è´¥: ' + data.msg + '</div>';
          return;
        }

        ALL_LICENSES = data.data; // é™çº§ä¸ºä»…ç¼“å­˜å½“å‰é¡µæ•°ç»„ï¼Œç”¨äºçƒ­å˜æ›´æ˜ å°„
        currentPagination = data.pagination;
        currentStats = data.stats;

        updateStats(currentStats);
        updateProductHelpers();
        renderCards(ALL_LICENSES, currentPagination);
      } catch (e) {
        container.style.opacity = '1';
        container.innerHTML = '<div style="padding:20px; color:var(--danger)">âš ï¸ æ— æ³•è¿æ¥æœåŠ¡å™¨</div>';
      }
    }

    // ä¹è§‚ UI å†…éƒ¨é™é»˜çƒ­æ¸²æŸ“å™¨ï¼Œä¸å¼•å‘é—ªçƒä¸ç½‘ç»œæ³¢åŠ¨
    function reRenderCards() {
      renderCards(ALL_LICENSES, currentPagination);
    }

    // æ¸²æŸ“åˆ—è¡¨è§†å›¾å¸ƒå±€
    function renderCards(list, pagination = null) {
      const container = document.getElementById('licListContainer');
      if (list.length === 0) {
        container.innerHTML = '<div style="text-align:center; padding:50px; color:var(--text-main)">ğŸ“­ æš‚æ— ç›¸å…³å¡å¯†æ•°æ®</div>';
        const topPag = document.getElementById('topPagination');
        if (topPag) topPag.innerHTML = '';
        return;
      }

      // æ‰€æœ‰çš„ list å³ä¸ºå·²ä»åç«¯åˆ‡ç‰‡å¥½çš„ pagedList
      const pagedList = list;

      // è·å–æ‰€æœ‰å½“å‰é¡µçš„å¡å¯† IDï¼Œä»¥ä¾¿å…¨é€‰æ¯”è¾ƒä½¿ç”¨
      const currentFilteredKeys = pagedList.map(l => l.license_key);

      // æ£€æŸ¥æ˜¯å¦åœ¨å½“å‰åˆ—è¡¨å’Œè·¨é¡µé›†åˆä¸­å…¨é€‰äº†
      const isAllChecked = pagedList.length > 0 && pagedList.every(l => SET_SELECTED_KEYS.has(l.license_key));

      let html = '<div class="lic-list">';
      html += `
    <div class="lic-header" style="grid-template-columns: 30px 1.5fr 1.5fr 1fr 1fr;">
      <div><input type="checkbox" class="custom-checkbox" ${isAllChecked ? 'checked' : ''} onclick="toggleAllCheckboxes(this)" title="å…¨é€‰å½“å‰åˆ—è¡¨"></div>
      <div>æˆæƒæ ‡è¯† & ä½¿ç”¨è€…</div>
      <div>äº§å“æƒé™ä¸æœ‰æ•ˆæœŸ</div>
      <div>åœ¨çº¿è®¾å¤‡</div>
      <div style="text-align:right">æ“ä½œ</div>
    </div>
  `;

      const now = new Date();

      // åŒæ­¥åˆ†é¡µå…ƒæ•°æ®ä¸ºç»„ä»¶ä½œç”¨åŸŸå˜é‡
      const totalPages = pagination ? pagination.total_pages : 1;
      const totalItems = pagination ? pagination.total : list.length;
      if (currentPage > totalPages) currentPage = totalPages;
      if (currentPage < 1) currentPage = 1;

      pagedList.forEach((lic) => {
        // å‡†å¤‡è®¢é˜…çŠ¶æ€ HTML
        let subHtml = '';
        if (lic.subscriptions && lic.subscriptions.length > 0) {
          subHtml = lic.subscriptions.map((s) => {
            let text = 'æ°¸ ä¹…';
            let cls = 'badge-success';
            if (s.expires_at) {
              const days = Math.ceil((new Date(s.expires_at) - now) / (86400000));
              text = days > 0 ? 'å‰© ' + days + ' å¤©' : 'å·²è¿‡æœŸ';
              cls = days > 7 ? 'badge-success' : (days > 0 ? 'badge-warning' : 'badge-danger');
            }
            return '<span class="badge ' + cls + '" style="margin-right:4px;">' + s.product_id + ': ' + text + '</span>';
          }).join('');
        } else {
          subHtml = '<span style="color:var(--text-main); font-size:11px; font-style:italic">æš‚æ— è®¢é˜…äº§å“</span>';
        }

        const isRevoked = lic.status === 'revoked';
        const devicePct = Math.min(100, (lic.current_devices / lic.max_devices) * 100);

        html += `
      <div class="lic-row" style="grid-template-columns: 30px 1.5fr 1.5fr 1fr 1fr;">
        <!-- Col 0: Checkbox -->
        <div style="display:flex; align-items:center;">
          <input type="checkbox" class="custom-checkbox row-checkbox" value="${lic.license_key}" ${SET_SELECTED_KEYS.has(lic.license_key) ? 'checked' : ''} onclick="toggleBatchItem('${lic.license_key}', this.checked)">
        </div>
        
        <!-- Col 1: åŸºæœ¬ä¿¡æ¯ -->
        <div style="display:flex; align-items:center; gap:12px; min-width:0;">
          <div style="width:36px; height:36px; flex-shrink:0; background:#30363d; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-weight:700; font-size:14px;">
            ${(lic.user_name || '?')[0].toUpperCase()}
          </div>
          <div style="min-width:0; overflow:hidden;">
            <div style="display:flex; align-items:center; gap:6px; margin-bottom:4px;">
              <span style="font-weight:600; font-size:13px; color:var(--text-bright); overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${lic.user_name || '<span style="color:var(--text-main); font-style:italic">æœªæŒ‡å®šç”¨æˆ·</span>'}</span>
              <span style="cursor:pointer; opacity:0.6; font-size:11px;" onclick="editUserName('${lic.license_key}','${lic.user_name || ""}')" title="ä¿®æ”¹ç”¨æˆ·å¤‡æ³¨">âœï¸</span>
              <span class="badge ${isRevoked ? 'badge-danger' : 'badge-success'}" style="transform: scale(0.85); transform-origin:left; margin-left:2px;">${lic.status.toUpperCase()}</span>
            </div>
            <div style="display:flex; align-items:center; gap:6px;">
              <span style="font-family:monospace; font-size:12px; color:var(--accent);">${lic.license_key}</span>
              <span style="cursor:pointer; opacity:0.6; font-size:12px;" onclick="copyText('${lic.license_key}')" title="å¤åˆ¶å¡å¯†">ğŸ“‹</span>
            </div>
          </div>
        </div>
        
        <!-- Col 2: è®¢é˜…æ ‡ç­¾ -->
        <div style="font-size:12px; display:flex; flex-wrap:wrap; gap:4px; align-items:center;">
          ${subHtml}
          <span onclick="addSub('${lic.license_key}')" style="color:var(--accent); cursor:pointer; font-weight:500; font-size:11px; margin-left:4px; padding:2px 6px; background:var(--accent-glow); border-radius:4px;">+ ç»­è´¹ç®¡ç†</span>
        </div>

        <!-- Col 3: è®¾å¤‡å ç”¨ -->
        <div style="font-size:12px; display:flex; flex-direction:column; justify-content:center;">
          <div style="color:var(--text-bright); margin-bottom:4px; font-weight:500; display:flex; align-items:center;">
            <div style="flex-shrink:0;">${lic.current_devices} <span style="color:var(--text-main); font-weight:normal;">/ ${lic.max_devices} å°</span></div>
            <button class="secondary" onclick="toggleDevicePanel('${lic.license_key}')" style="margin-left:6px; padding:2px 6px; font-size:11px; height:auto; background:var(--panel-bg); border-color:#30363d; flex-shrink:0;" title="å±•å¼€æŸ¥çœ‹å…·ä½“è®¾å¤‡">ğŸ” è¯¦æƒ…</button>
          </div>
          <div style="height:4px; width:100%; max-width:80px; background:#30363d; border-radius:2px; overflow:hidden;">
            <div style="width:${devicePct}%; height:100%; background:var(--accent);"></div>
          </div>
        </div>

        <!-- Col 4: æ“ä½œ -->
        <div style="display:flex; gap:8px; justify-content:flex-end;">
          <button class="secondary" style="padding:4px 8px; font-size:12px;" onclick="toggleStatus('${lic.license_key}', '${isRevoked ? 'active' : 'revoked'}')">
            ${isRevoked ? 'ğŸ”“ æ¢å¤' : 'ğŸ”’ åŠé”€'}
          </button>
          <button class="danger" style="padding:4px 8px; font-size:12px;" onclick="deleteLic('${lic.license_key}')" title="å½»åº•åˆ é™¤">ğŸ—‘ï¸</button>
        </div>
      </div>
      <!-- åŠ¨æ€è®¾å¤‡é¢æ¿æ’æ§½ -->
      <div id="devicePanel_${lic.license_key}" style="display:none; grid-column:1/-1; background:#0d1117; border-top:1px dashed #30363d; padding:12px 16px;"></div>
    `;
      });

      html += '</div>';

      html += '</div>';

      // ==========================================
      // æ›´æ–°é¡¶éƒ¨åŠåº•éƒ¨åˆ†é¡µå¯¼èˆª (æå–é€»è¾‘)
      // ==========================================
      const renderPagination = () => {
        if (totalItems === 0) return '';
        return `
          <div style="display:flex; align-items:stretch; gap:8px;">
            <select style="padding:0 12px; font-size:14px; border-radius:6px; background:#21262d; color:var(--text-bright); border:1px solid var(--border-color); outline:none; cursor:pointer;" onchange="changePageSize(this.value)">
              <option value="10" ${PAGE_SIZE === 10 ? 'selected' : ''}>10æ¡/é¡µ</option>
              <option value="20" ${PAGE_SIZE === 20 ? 'selected' : ''}>20æ¡/é¡µ</option>
              <option value="50" ${PAGE_SIZE === 50 ? 'selected' : ''}>50æ¡/é¡µ</option>
              <option value="100" ${PAGE_SIZE === 100 ? 'selected' : ''}>100æ¡/é¡µ</option>
            </select>
            <button class="secondary" style="white-space:nowrap; flex-shrink:0;" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled style="opacity:0.5;cursor:not-allowed"' : ''}>â† ä¸Šä¸€é¡µ</button>
            <div style="display:flex; align-items:center; padding:0 16px; font-size:14px; color:var(--text-main); background:var(--card-bg); border-radius:6px; border:1px solid var(--border-color); white-space:nowrap; flex-shrink:0;">
              ç¬¬ <span style="color:var(--text-bright); font-weight:bold; margin:0 4px;">${currentPage}</span>/ ${totalPages} é¡µ
            </div>
            <button class="secondary" style="white-space:nowrap; flex-shrink:0;" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled style="opacity:0.5;cursor:not-allowed"' : ''}>ä¸‹ä¸€é¡µ â†’</button>
          </div>
        `;
      };

      const topPag = document.getElementById('topPagination');
      if (topPag) {
        topPag.innerHTML = renderPagination();
      }

      container.innerHTML = html;
    }

    // åˆ‡æ¢åˆ†é¡µå¤§å°
    function changePageSize(size) {
      PAGE_SIZE = parseInt(size);
      currentPage = 1;
      filterLocalList(false);
    }

    // åˆ†é¡µè·³è½¬å‡½æ•°
    function goToPage(page) {
      currentPage = page;
      filterLocalList(false);
      window.scrollTo({ top: document.getElementById('licListContainer').offsetTop - 60, behavior: 'smooth' });
    }

    // é˜²æŠ–æœç´¢ï¼ˆ300mså»¶è¿Ÿï¼‰
    let searchTimer = null;
    function debounceSearch() {
      clearTimeout(searchTimer);
      searchTimer = setTimeout(() => filterLocalList(true), 300);
    }

    // çŠ¶æ€ç­›é€‰
    let currentStatusFilter = 'all';
    function filterStatus(status, btnElement) {
      currentStatusFilter = status;
      document.querySelectorAll('#statusFilterGroup button').forEach(btn => {
        btn.style.background = '';
        btn.style.color = 'var(--text-bright)';
      });
      if (btnElement) {
        btnElement.style.background = 'var(--accent)';
        btnElement.style.color = '#fff';
      }
      filterLocalList(true);
    }

    // æ’åº
    let currentSort = 'created_desc';
    function applySort() {
      currentSort = document.getElementById('sortOrder').value;
      filterLocalList(true);
    }

    // ç”Ÿå¡è¾…åŠ©è®¡ç®—
    function updateGenInfo() {
      const count = parseInt(document.getElementById('genCount').value) || 1;
      const maxDevices = parseInt(document.getElementById('genMaxDevices').value) || 2;
      const totalDevices = count * maxDevices;
      document.getElementById('genInfo').innerText = `å ç”¨æ•´ä½“é…é¢ï¼š${totalDevices}å° (${count}å¼ å¡ Ã— ${maxDevices}å°)`;
    }

    function setGenPreset(count, maxDevices, duration) {
      document.getElementById('genCount').value = count;
      document.getElementById('genMaxDevices').value = maxDevices;
      document.getElementById('genDuration').value = duration || '';
      updateGenInfo();
    }

    // æœç´¢è¿‡æ»¤ä¸å¤šç»´æ’åºæ ¸å¿ƒ
    function filterLocalList(resetPage = true) {
      if (resetPage) currentPage = 1;
      loadLicenses(); // æ‰€æœ‰æ’åºä¸è¿‡æ»¤è®¡ç®—å¼•æ“ä¸‹æ²‰è‡³åç«¯
    }

    // ç”Ÿå¡é€»è¾‘
    async function doGenerate() {
      const btn = document.getElementById('btnDoGen');
      const pId = document.getElementById('genProductId').value;
      const uName = document.getElementById('genUserName').value;
      const cnt = parseInt(document.getElementById('genCount').value);
      const mD = parseInt(document.getElementById('genMaxDevices').value);
      const dur = document.getElementById('genDuration').value;

      btn.disabled = true; btn.innerText = "âš¡ æ­£åœ¨ç‚¼åˆ¶æ¿€æ´»ç ...";

      try {
        const res = await fetch('/api/v1/auth/admin/generate', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + ADMIN_SECRET, 'Content-Type': 'application/json' },
          body: JSON.stringify({ product_id: pId, user_name: uName, count: cnt, max_devices: mD, duration_days: dur ? parseInt(dur) : null })
        });
        const data = await res.json();
        if (data.success) {
          showToast(`æˆåŠŸç”Ÿæˆ ${data.keys.length} å¼ å¡å¯†ï¼Œå·²è‡ªåŠ¨ä¸ºæ‚¨é€‰ä¸­ï¼`, 'success');
          document.getElementById('genResult').style.display = 'block';
          document.getElementById('genOutput').innerText = data.keys.join('\n');

          // å¿ƒæ™ºæµè½¬ï¼šé‡ç½®åˆ—è¡¨è§†å›¾å±æ€§
          clearBatchSelection();
          data.keys.forEach(k => SET_SELECTED_KEYS.add(k));
          document.getElementById('keywordSearch').value = '';
          document.getElementById('filterProductId').value = '';
          filterStatus('all', document.querySelector('#statusFilterGroup button'));

          // è·³è½¬ä¸æ‰§è¡Œ
          switchTab('manage');
          // å› ä¸º switchTab('manage') å†…è°ƒç”¨äº†ä¸è¿”å› Promise çš„ loadLicenses()ï¼Œ
          // ç”¨çŸ­å»¶æ—¶æˆ–æ‹¦æˆªå»ç¡®ä¿åº•éƒ¨ batchBar å‡ºç°
          setTimeout(() => {
            updateBatchBar();
            document.getElementById('batchBar').classList.add('pulse-highlight');
            setTimeout(() => document.getElementById('batchBar').classList.remove('pulse-highlight'), 1000);
          }, 800);

        } else { showToast('é”™è¯¯: ' + data.msg, 'error'); }
      } catch (e) { showToast('é€šè®¯å¤±è´¥: ' + e.message, 'error'); }
      finally { btn.disabled = false; btn.innerText = "âœ¨ ç«‹å³åˆ¶å¡å¹¶æ¿€æ´»è®¢é˜…"; }
    }

    // API äº¤äº’å‡½æ•°
    async function toggleStatus(key, status) {
      const isRestore = status === 'active';
      const confirmed = await showModal({
        title: isRestore ? 'ğŸ”“ æ¢å¤ä½¿ç”¨' : 'ğŸ”’ åŠé”€å¡å¯†',
        message: 'ç¡®å®šè¦' + (isRestore ? 'æ¢å¤' : 'åŠé”€') + 'å¡å¯†[<span style="color:var(--accent)">' + key + '</span>]å—ï¼Ÿ',
        confirmText: 'ç¡®å®š',
        danger: !isRestore
      });
      if (!confirmed) return;

      try {
        const res = await fetch('/api/v1/auth/admin/licenses/status', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + ADMIN_SECRET, 'Content-Type': 'application/json' },
          body: JSON.stringify({ license_key: key, status })
        });
        const data = await res.json();
        if (data.success) {
          const lic = ALL_LICENSES.find(l => l.license_key === key);
          if (lic) {
            lic.status = status;
            if (currentStats) {
              if (status === 'active') { currentStats.active++; currentStats.revoked--; }
              else { currentStats.active--; currentStats.revoked++; }
            }
            updateStats(currentStats);
            reRenderCards(); // é«˜æ•ˆé™æ€é‡ç»˜
          }
          showToast(data.msg || 'çŠ¶æ€å·²æ›´æ–°', 'success');
        } else {
          showToast(data.msg || 'æ“ä½œå¤±è´¥', 'error');
        }
      } catch (e) {
        showToast('ç½‘ç»œé”™è¯¯: ' + e.message, 'error');
      }
    }

    async function deleteLic(key) {
      const confirmed = await showModal({
        title: 'ğŸ—‘ï¸ å½»åº•åœäº§',
        message: 'âš ï¸ å±é™©: ç¡®å®šåˆ é™¤å¡å¯†[<span style="color:var(--danger)">' + key + '</span>]å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼',
        confirmText: 'ç¡®è®¤åˆ é™¤',
        danger: true
      });
      if (!confirmed) return;

      try {
        const res = await fetch('/api/v1/auth/admin/licenses', {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + ADMIN_SECRET, 'Content-Type': 'application/json' },
          body: JSON.stringify({ license_key: key })
        });
        const data = await res.json();
        if (data.success) {
          ALL_LICENSES = ALL_LICENSES.filter(l => l.license_key !== key);
          SET_SELECTED_KEYS.delete(key);
          updateBatchBar();

          if (currentStats && currentStats.total > 0) currentStats.total--;
          updateStats(currentStats);

          // å¦‚æœå½“å‰é¡µè¢«åˆ ç©ºï¼Œä¸”ä¸æ˜¯ç¬¬ä¸€é¡µï¼Œè‡ªåŠ¨é€€ä¸€é¡µæ‹‰å–
          if (ALL_LICENSES.length === 0 && currentPage > 1) {
            currentPage--;
          }
          filterLocalList(false); // ç‰©ç†åˆ é™¤å¿…é¡»è®©åç«¯å¡«è¡¥ç©ºä½
          showToast('å·²å½»åº•åˆ é™¤è¯¥å¡å¯†', 'success');
        } else {
          showToast(data.msg || 'åˆ é™¤å¤±è´¥', 'error');
        }
      } catch (e) {
        showToast('ç½‘ç»œé”™è¯¯: ' + e.message, 'error');
      }
    }

    async function editUserName(key, cur) {
      const res = await showModal({
        title: 'âœï¸ ä¿®æ”¹ç”¨æˆ·å¤‡æ³¨',
        inputs: [{ label: 'ç”¨æˆ·åæˆ–å†…éƒ¨å¤‡æ³¨', value: cur, placeholder: 'è¾“å…¥æ–°å¤‡æ³¨' }],
        confirmText: 'ä¿å­˜ä¿®æ”¹'
      });
      if (!res) return;
      const n = res[0];

      try {
        const fetchRes = await fetch('/api/v1/auth/admin/licenses/user', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + ADMIN_SECRET, 'Content-Type': 'application/json' },
          body: JSON.stringify({ license_key: key, user_name: n })
        });
        const data = await fetchRes.json();
        if (data.success) {
          const lic = ALL_LICENSES.find(l => l.license_key === key);
          if (lic) {
            lic.user_name = n;
            reRenderCards(); // æ–‡æœ¬çƒ­å˜æ›´ï¼Œé›¶é—ªçƒ
          }
          showToast('å¤‡æ³¨å·²æ›´æ–°', 'success');
        } else {
          showToast(data.msg || 'æ›´æ–°å¤±è´¥', 'error');
        }
      } catch (e) {
        showToast('ç½‘ç»œé”™è¯¯: ' + e.message, 'error');
      }
    }
    // æ·»åŠ äº§å“ç»­è´¹ç®¡ç†
    async function addSub(key) {
      const res = await showModal({
        title: 'â• æ·»åŠ è®¢é˜…æˆ–ç»­è´¹',
        message: 'æ­£åœ¨ä¸º <b>' + key + '</b> é…ç½®æƒé™ã€‚<br/><span style="color:var(--warning); font-size:12px;">æ³¨ï¼šå¦‚éœ€æ¸…é™¤è¯¯ç»‘äº§å“ï¼Œè¯·å¡«å…¥äº§å“ ID å¹¶å°†æ—¶é•¿è®¾ä¸º 0ã€‚</span>',
        inputs: [
          { label: 'äº§å“çº¿æ ‡è¯† (Product ID)', value: 'smartmp', placeholder: 'å¦‚ smartmp' },
          { label: 'ç»­è´¹æ—¶é•¿ (å¤©æ•°)', value: '365', placeholder: 'å¡« 365 å³åŠ ä¸€å¹´ï¼Œå¡« 0 æ¸…é™¤ï¼Œç•™ç©ºæ°¸ä¹…' }
        ],
        confirmText: 'ç¡®è®¤åŠç†'
      });

      if (!res) return;
      const pId = res[0] ? res[0].trim() : '';
      const dVal = res[1] ? res[1].trim() : '';
      if (!pId) return;

      let days = null;
      if (dVal !== '') {
        days = parseInt(dVal);
        if (isNaN(days)) return showModal({ title: 'é”™è¯¯', message: 'å¤©æ•°å¿…é¡»æ˜¯çº¯æ•°å­—', type: 'alert' });
      }

      try {
        const fRes = await fetch('/api/v1/auth/admin/subscriptions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + ADMIN_SECRET },
          body: JSON.stringify({ license_key: key, product_id: pId, duration_days: days })
        });
        const data = await fRes.json();

        if (data.success) {
          showToast(data.deleted ? 'æƒé™é…ç½®å·²æ¸…ç†' : 'è®¢é˜…å·²ç»­æœŸæ›´æ–°æˆåŠŸ', 'success');
          const lic = ALL_LICENSES.find(l => l.license_key === key);
          if (lic) {
            if (data.deleted) {
              lic.subscriptions = (lic.subscriptions || []).filter(s => s.product_id !== pId);
            } else {
              const subObj = { product_id: pId, expires_at: data.expires_at };
              lic.subscriptions = lic.subscriptions || [];
              const existIdx = lic.subscriptions.findIndex(s => s.product_id === pId);
              if (existIdx >= 0) {
                lic.subscriptions[existIdx] = subObj;
              } else {
                lic.subscriptions.push(subObj);
              }
            }
            updateProductHelpers();
            filterLocalList(false); // å±€éƒ¨çƒ­æ›´æ–°
          }
        } else {
          showToast(data.msg || 'æ“ä½œæœªç”Ÿæ•ˆ', 'error');
        }
      } catch (e) {
        showModal({ title: 'å‘ç”Ÿé”™è¯¯', message: e.message, type: 'alert' });
      }
    }

    function copyText(t) {
      navigator.clipboard.writeText(t);
      const btn = window.event?.currentTarget;
      if (btn) {
        const old = btn.innerText;
        btn.innerText = 'âœ…';
        setTimeout(() => { btn.innerText = old; }, 1000);
      }
    }
    async function copyGenResult() {
      const txt = document.getElementById('genOutput').innerText;
      await navigator.clipboard.writeText(txt);
      showModal({ title: 'å¤åˆ¶æˆåŠŸ', message: 'å·²å°†æ‰€æœ‰æ¿€æ´»ç å­˜å…¥å‰ªè´´æ¿', type: 'alert' });
    }

    async function exportData() {
      if (ALL_LICENSES.length === 0) return showModal({ title: 'æç¤º', message: 'å½“å‰æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®', type: 'alert' });
      const dataStr = JSON.stringify(ALL_LICENSES, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'hw-licenses-backup-' + Date.now() + '.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // å¯¼å‡ºä¸ºé€‚åˆ Excel æ‰“å¼€çš„ CSV æ ¼å¼è¡¨æ ¼
    async function exportExcel() {
      if (ALL_LICENSES.length === 0) return showModal({ title: 'æç¤º', message: 'å½“å‰æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®', type: 'alert' });

      // 1. æ„å»º CSV è¡¨å¤´
      let csvContent = 'æ¿€æ´»ç æ ‡è¯†,ç»‘å®šç”¨æˆ·/å¤‡æ³¨,çŠ¶æ€,è®¾å¤‡é…é¢,å·²åˆ†é…è®¾å¤‡,åŒ…å«äº§å“æ•°,è®¢é˜…è¯¦æƒ…æ‘˜è¦,åˆ›å»ºæ—¶é—´\n';

      // 2. éå†æ•°æ®å¹³é“ºé™ç»´
      ALL_LICENSES.forEach(lic => {
        // å¤„ç†å¯èƒ½åŒ…å«é€—å·çš„å­—æ®µï¼Œç”¨å¼•å·åŒ…è£¹
        const safeStr = (str) => '"' + (str ? String(str).replace(/"/g, '""') : '') + '"';

        // åˆå¹¶è®¢é˜…è¯¦æƒ…ä¸ºä¸€ä¸ªæ˜“è¯»çš„å­—ç¬¦ä¸²
        const subDigest = (lic.subscriptions || []).map(s => {
          const expStr = s.expires_at ? new Date(s.expires_at).toLocaleDateString() : 'æ°¸ä¹…';
          return '[' + s.product_id + ': ' + expStr + ']';
        }).join(' | ');

        const row = [
          safeStr(lic.license_key),
          safeStr(lic.user_name || 'æœªé…ç½®'),
          lic.status === 'revoked' ? 'å·²åŠé”€' : 'æ´»è·ƒ',
          lic.max_devices,
          lic.current_devices,
          (lic.subscriptions || []).length,
          safeStr(subDigest),
          safeStr(new Date(lic.created_at).toLocaleString())
        ];
        csvContent += row.join(',') + '\n';
      });

      // 3. åŠ ä¸Š UTF-8 BOMï¼Œé˜²æ­¢ Windows ä¸‹ Excel æ‰“å¼€ç›´æ¥ä¹±ç 
      const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'hw-licenses-report-' + Date.now() + '.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    async function importData(event) {
      const file = event.target.files[0];
      if (!file) return;
      event.target.value = '';

      const isCSV = file.name.toLowerCase().endsWith('.csv');

      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const contentStr = e.target?.result;
          let licenses = [];

          if (isCSV) {
            // CSV è§£æå¼•æ“
            const rows = [];
            let cur = '';
            let inQuote = false;
            for (let i = 0; i < contentStr.length; i++) {
              const c = contentStr[i];
              if (c === '"') {
                if (inQuote && contentStr[i + 1] === '"') {
                  cur += '"';
                  i++; // skip escaped quote
                } else {
                  inQuote = !inQuote;
                }
              } else if (c === ',' && !inQuote) {
                rows.push(cur);
                cur = '';
              } else if ((c === '\n' || c === '\r') && !inQuote) {
                if (c === '\r' && contentStr[i + 1] === '\n') i++; // CRLF
                rows.push(cur);
                if (rows.length > 1 || rows[0] !== '') {
                  // Skip header row if it contains 'æ¿€æ´»ç æ ‡è¯†'
                  if (!(rows.length > 0 && String(rows[0]).includes('æ¿€æ´»ç æ ‡è¯†'))) {
                    // é€†å‘æ˜ å°„
                    const key = rows[0]?.trim();
                    if (key) {
                      const userName = rows[1]?.trim();
                      const status = rows[2]?.trim() === 'å·²åŠé”€' ? 'revoked' : 'active';
                      const maxDev = parseInt(rows[3]) || 2;

                      // æå– subscriptions digest (åˆ— 6: e.g., "[smartmp: 2024/01/01] | [other: æ°¸ä¹…]")
                      const subDigest = rows[6] || '';
                      const subs = [];
                      const subRegex = /\\[(.*?) ?: ?(.*?)\\]/g;
                      let match;
                      while ((match = subRegex.exec(subDigest)) !== null) {
                        const pId = match[1].trim();
                        const expVal = match[2].trim();
                        let expDate = null;
                        if (expVal !== 'æ°¸ä¹…' && expVal !== 'æœªçŸ¥') {
                          const parsed = new Date(expVal);
                          if (!isNaN(parsed.getTime())) {
                            expDate = parsed.toISOString();
                          }
                        }
                        subs.push({ product_id: pId, expires_at: expDate });
                      }

                      licenses.push({
                        license_key: key,
                        user_name: userName === 'æœªé…ç½®' ? '' : userName,
                        status: status,
                        max_devices: maxDev,
                        subscriptions: subs
                      });
                    }
                  }
                }
                rows.length = 0;
                cur = '';
              } else {
                cur += c;
              }
            }
            if (cur || rows.length) {
              rows.push(cur);
              if (rows.length > 0 && rows[0]?.trim() && !String(rows[0]).includes('æ¿€æ´»ç æ ‡è¯†')) {
                // Copy pasted mapping
                const key = rows[0]?.trim();
                if (key) {
                  const userName = rows[1]?.trim();
                  const status = rows[2]?.trim() === 'å·²åŠé”€' ? 'revoked' : 'active';
                  const maxDev = parseInt(rows[3]) || 2;
                  const subDigest = rows[6] || '';
                  const subs = [];
                  const subRegex = /\\[(.*?) ?: ?(.*?)\\]/g;
                  let match;
                  while ((match = subRegex.exec(subDigest)) !== null) {
                    const pId = match[1].trim();
                    const expVal = match[2].trim();
                    let expDate = null;
                    if (expVal !== 'æ°¸ä¹…' && expVal !== 'æœªçŸ¥') {
                      const parsed = new Date(expVal);
                      if (!isNaN(parsed.getTime())) {
                        expDate = parsed.toISOString();
                      }
                    }
                    subs.push({ product_id: pId, expires_at: expDate });
                  }
                  licenses.push({
                    license_key: key,
                    user_name: userName === 'æœªé…ç½®' ? '' : userName,
                    status: status,
                    max_devices: maxDev,
                    subscriptions: subs
                  });
                }
              }
            }
            if (licenses.length === 0) throw new Error("CSV æ•°æ®ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®");

          } else {
            // JSON å¯¼å…¥å¤„ç†
            licenses = JSON.parse(contentStr);
            if (!Array.isArray(licenses)) throw new Error("æ ¼å¼é”™è¯¯ï¼Œé JSON æ•°ç»„ï¼");
          }

          const confirmed = await showModal({
            title: 'æ‰¹é‡å¯¼å…¥ç¡®è®¤',
            message: `å³å°†æ‰¹é‡å¯¼å…¥ ${licenses.length} æ¡æ•°æ®ï¼Œå·²å­˜åœ¨çš„æ•°æ®å°†ä¼šè¢«èåˆè¦†ç›–ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ`,
            confirmText: 'ç¡®è®¤å¯¼å…¥',
            danger: true
          });
          if (!confirmed) return;

          // ä½¿ç”¨é®ç½©é˜²æ­¢äºŒæ¬¡ç‚¹å‡»
          const btn = document.querySelector('.modal-footer .primary');
          if (btn) btn.innerText = "ä¸Šä¼ ä¸­...";

          const fRes = await fetch('/api/v1/auth/admin/licenses/import', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + ADMIN_SECRET },
            body: JSON.stringify({ licenses })
          });

          const data = await fRes.json();
          if (data.success) {
            showToast('å¯¼å…¥æˆåŠŸï¼š' + data.msg, 'success');
            loadLicenses();
          } else {
            showToast('å¯¼å…¥å¤±è´¥ï¼š' + data.msg, 'error');
          }
        } catch (err) {
          showToast('è§£æé”™è¯¯ï¼š' + err.message, 'error');
        }
      };
      reader.readAsText(file);
    }

    // ==========================================
    // æ‰¹é‡æ“ä½œé€»è¾‘
    // ==========================================
    function updateBatchBar() {
      const bar = document.getElementById('batchBar');
      const countDisplay = document.getElementById('batchCountDisplay');
      if (!bar || !countDisplay) return;
      const count = SET_SELECTED_KEYS.size;
      countDisplay.innerText = count + ' é¡¹é€‰ä¸­';
      if (count > 0) {
        bar.classList.add('active');
      } else {
        bar.classList.remove('active');
      }
    }

    function toggleBatchItem(key, isChecked) {
      if (isChecked) {
        SET_SELECTED_KEYS.add(key);
      } else {
        SET_SELECTED_KEYS.delete(key);
      }
      updateBatchBar();
    }

    function toggleAllCheckboxes(checkboxElem) {
      const isChecked = checkboxElem.checked;
      document.querySelectorAll('.row-checkbox').forEach(cb => {
        cb.checked = isChecked;
        if (isChecked) {
          SET_SELECTED_KEYS.add(cb.value);
        } else {
          SET_SELECTED_KEYS.delete(cb.value);
        }
      });
      updateBatchBar();
    }

    function clearBatchSelection() {
      SET_SELECTED_KEYS.clear();
      document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = false);
      const headerCb = document.querySelector('.lic-header .custom-checkbox');
      if (headerCb) headerCb.checked = false;
      updateBatchBar();
    }

    // å…¨é€‰å½“å‰ç­›é€‰ç»“æœ
    function selectAllFiltered() {
      const kw = document.getElementById('keywordSearch').value.toLowerCase();
      const pId = document.getElementById('filterProductId').value;

      let filtered = ALL_LICENSES.filter(l => {
        const matchKeyword = !kw ||
          l.license_key.toLowerCase().includes(kw) ||
          (l.user_name && l.user_name.toLowerCase().includes(kw));
        const matchProduct = !pId || l.product_id === pId;
        let matchStatus = true;
        if (currentStatusFilter === 'active') matchStatus = l.status === 'active';
        else if (currentStatusFilter === 'revoked') matchStatus = l.status === 'revoked';
        return matchKeyword && matchProduct && matchStatus;
      });

      filtered.forEach(l => SET_SELECTED_KEYS.add(l.license_key));
      filterLocalList(false); // è§¦å‘é‡æ–°æ¸²æŸ“ä»¥å›æ˜¾å‹¾é€‰
      updateBatchBar();
      showToast(`å·²å…¨é€‰å½“å‰è§†å›¾ä¸‹çš„ ${filtered.length} ä¸ªç»“æœã€‚`, 'success');
    }

    // æç®€åŒ–çš„æ‰¹é‡æ‰§è¡Œæµç¨‹ï¼ˆé›¶åŠ¨ç”»ã€æ— é˜»å¡æç¤ºå“åº”ï¼‰
    async function executeBatch() {
      const actionSelect = document.getElementById('batchActionSelect');
      const action = actionSelect ? actionSelect.value : '';
      if (!action) {
        showToast('è¯·å…ˆé€‰æ‹©éœ€è¦æ‰§è¡Œçš„æ‰¹é‡åŠ¨ä½œ', 'warning');
        return;
      }

      const keys = Array.from(SET_SELECTED_KEYS);
      if (keys.length === 0) {
        showToast('è¯·å…ˆå‹¾é€‰è‡³å°‘ä¸€å¼ å¡å¯†', 'warning');
        return;
      }

      // å‰ç«¯çº¯æ–‡å­—æå–
      if (action === 'copy_keys') {
        try {
          await navigator.clipboard.writeText(keys.join('\n'));
          showToast(`å·²å¤åˆ¶ ${keys.length} ä¸ªæ¿€æ´»ç åˆ°å‰ªè´´æ¿ï¼`, 'success');
          clearBatchSelection();
        } catch (e) {
          showToast('å¤åˆ¶å¤±è´¥ï¼Œæ‚¨çš„æµè§ˆå™¨å¯èƒ½é˜»æ‹¦äº†å‰ªè´´æ¿è®¿é—®ã€‚', 'error');
        }
        return;
      }

      const optionText = actionSelect.options[actionSelect.selectedIndex].text.replace(/^[\u0000-\uFFFF]{1,3}\s/, '');
      const confirmed = await showModal({
        title: 'æ‰¹é‡æ“ä½œç¡®è®¤',
        message: `ğŸš€ æœ€ç»ˆç¡®è®¤ï¼šæ˜¯å¦å¯¹ ${keys.length} ä¸ªå¡å¯†æ‰§è¡Œ [${optionText}] æ“ä½œï¼Ÿ`,
        confirmText: 'ç¡®å®šæ‰§è¡Œ',
        danger: true
      });
      if (!confirmed) return;

      let params = {};

      if (action === 'set_user_name') {
        const res = await showModal({
          title: 'ä¿®æ”¹å¤‡æ³¨',
          inputs: [{ label: `å¯¹ ${keys.length} ä¸ªå¡å¯†ä¿®æ”¹å¤‡æ³¨ä¸ºï¼š`, value: '', placeholder: 'è¾“å…¥æ–°å¤‡æ³¨' }],
          confirmText: 'ç¡®å®š'
        });
        if (!res) return;
        params.user_name = res[0] || '';
      } else if (action === 'set_max_devices') {
        const res = await showModal({
          title: 'ä¿®æ”¹è®¾å¤‡ä¸Šé™',
          inputs: [{ label: `è°ƒæ•´ ${keys.length} ä¸ªå¡å¯†çš„è®¾å¤‡ä¸Šé™ (1-1000)ï¼š`, value: '2', type: 'number' }],
          confirmText: 'ç¡®å®š'
        });
        if (!res) return;
        params.max_devices = parseInt(res[0]) || 1;
      } else if (action === 'add_subscription') {
        const res = await showModal({
          title: 'ç»­è´¹/åŠ äº§å“',
          inputs: [
            { label: 'äº§å“è¯†åˆ« ID (ä¾‹å¦‚ smartmp)ï¼š', value: '', placeholder: 'å¦‚ smartmp' },
            { label: 'æœ‰æ•ˆå¤©æ•° (ç•™ç©ºè¡¨ç¤ºæ°¸ä¹…)ï¼š', value: '365', type: 'number' }
          ],
          confirmText: 'ç¡®å®š'
        });
        if (!res || !res[0]) return;
        params.product_id = res[0];
        params.duration_days = res[1] ? parseInt(res[1]) : null;
      } else if (action === 'remove_subscription') {
        const res = await showModal({
          title: 'å‰¥å¤ºæŒ‡å®šäº§å“æƒé™',
          inputs: [{ label: 'è¦å‰¥å¤ºæƒé™çš„äº§å“ IDï¼š', value: '', placeholder: 'å¦‚ smartmp' }],
          confirmText: 'ç¡®å®š',
          danger: true
        });
        if (!res || !res[0]) return;
        params.product_id = res[0];
      }

      try {
        const res = await fetch('/api/v1/auth/admin/licenses/batch', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + ADMIN_SECRET,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ keys, action, params })
        });
        const data = await res.json();

        if (data.success) {
          clearBatchSelection();
          showToast(data.msg, 'success');
          loadLicenses();
        } else {
          showToast('æ‰§è¡Œå¤±è´¥ï¼š' + data.msg, 'error');
        }
      } catch (err) {
        showToast('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼š' + (err.message || err), 'error');
      }
    }

    // ==========================================
    // è®¾å¤‡æ˜ç»†é¢æ¿æ§åˆ¶ (é›¶åŠ¨ç”»ç²¾ç®€ç‰ˆ)
    // ==========================================
    async function toggleDevicePanel(key) {
      const panel = document.getElementById('devicePanel_' + key);
      if (!panel) return;

      if (panel.style.display === 'block') {
        panel.style.display = 'none';
        return;
      }

      panel.style.display = 'block';
      panel.innerHTML = '<div style="color:var(--text-main); font-size:12px; padding:10px;">âŒ› åŠ è½½ä¸­...</div>';

      try {
        const res = await fetch('/api/v1/auth/admin/licenses/' + key + '/devices', {
          headers: { 'Authorization': 'Bearer ' + ADMIN_SECRET }
        });
        const data = await res.json();

        if (!data.success) {
          panel.innerHTML = '<div style="color:var(--danger); font-size:12px;">âŒ åŠ è½½å¤±è´¥: ' + data.msg + '</div>';
          return;
        }

        const devices = data.data;
        if (devices.length === 0) {
          panel.innerHTML = '<div style="color:var(--text-main); font-size:12px;">ğŸ“­ æš‚æ— ç»‘å®šè®¾å¤‡ã€‚</div>';
          return;
        }

        // è¶…æç®€è¡¨æ ¼æ›¿ä»£å¤æ‚çš„è¡¨æ ¼æ¡†æ¶ç»“æ„ä»¥é™ä½èŠ‚ç‚¹é‡
        let html = `<div style="padding:8px 12px; font-size:12px;"><strong>å…±è®¡ ${devices.length} å°åœ¨çº¿è®¾å¤‡ï¼š</strong></div>`;
        devices.forEach(d => {
          const lActive = d.last_active ? new Date(d.last_active + 'Z').toLocaleString('zh-CN') : 'æœªçŸ¥';
          html += `
            <div style="padding:8px 12px; border-top:1px solid #30363d; font-size:12px; display:flex; justify-content:space-between; align-items:center;">
              <div>
                <div style="color:var(--text-bright); margin-bottom:4px;"><strong>${d.device_name || 'æœªå‘½åè®¾å¤‡'}</strong></div>
                <div style="font-family:monospace; color:var(--text-main); margin-bottom:2px;">${d.device_id}</div>
                <div style="color:var(--text-main); font-size:11px;">æœ€ååœ¨çº¿: ${lActive}</div>
              </div>
              <button class="secondary" style="padding:6px 10px; font-size:12px; color:var(--danger);" onclick="removeSingleDevice('${key}', '${d.device_id}')">å¼ºåˆ¶è§£ç»‘</button>
            </div>
          `;
        });

        panel.innerHTML = html;

      } catch (err) {
        panel.innerHTML = '<div style="color:var(--danger); font-size:12px;">âŒ æ— æ³•å­˜å–è®¾å¤‡æ•°æ®</div>';
      }
    }

    async function removeSingleDevice(key, deviceId) {
      const confirmed = await showModal({
        title: 'å¼ºåˆ¶è§£ç»‘è®¾å¤‡',
        message: 'ç¡®å®šè¦å¼ºåˆ¶æ³¨é”€è¯¥è®¾å¤‡å—ï¼Ÿè¸¢å‡ºåï¼Œç‰¹å®šå®¢æˆ·ç«¯å°†å¤±å»æˆæƒç½‘ç»œã€‚',
        confirmText: 'ç¡®è®¤æ³¨é”€',
        danger: true
      });
      if (!confirmed) return;

      try {
        const res = await fetch('/api/v1/auth/admin/licenses/' + key + '/devices/' + encodeURIComponent(deviceId), {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + ADMIN_SECRET }
        });
        const data = await res.json();
        if (data.success) {
          toggleDevicePanel(key);
          setTimeout(() => toggleDevicePanel(key), 300);
          loadLicenses();
        } else {
          showToast('æ“ä½œå¤±è´¥: ' + data.msg, 'error');
        }
      } catch (err) {
        showToast('ç½‘ç»œé”™è¯¯: ' + err.message, 'error');
      }
    }

    // ==========================================
    // é«˜çº§åŠŸèƒ½ï¼šé”®ç›˜å¿«æ·é”®æ”¯æŒ
    // ==========================================
    document.addEventListener('keydown', (e) => {
      // Ctrl/Cmd + K: èšç„¦å…¨å±€æœç´¢
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') {
        e.preventDefault();
        const searchInput = document.getElementById('keywordSearch');
        if (searchInput) searchInput.focus();
      }

      // Ctrl/Cmd + R: æ— åŠ¨ç”»é™é»˜åˆ·æ–°æ•°æ®åˆ—è¡¨
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'r' && !e.shiftKey) {
        e.preventDefault();
        loadLicenses();
      }

      // Esc: æ”¶èµ·ç›®å‰æ‰“å¼€çš„æ‰€æœ‰æ¨¡æ€æ¡†/ä¸‹æ‹‰é¢æ¿
      if (e.key === 'Escape') {
        closeModal();
      }
    });
  </script>
</body>

</html>