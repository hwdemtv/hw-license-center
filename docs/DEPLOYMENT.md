# éƒ¨ç½²æ–¹æ¡ˆæŒ‡å— (v22+)

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•å°†æœ¬å¡å¯†ç®¡ç†ç³»ç»Ÿéƒ¨ç½²åˆ°ä¸åŒç¯å¢ƒä¸­ã€‚æœ¬é¡¹ç›®ç›®å‰å·²å®ç° **åŒæ –æ¶æ„ (Dual Deployment)**ï¼Œä¸€å¥—ä»£ç å¯åŸç”Ÿè¿è¡Œäºè¾¹ç¼˜è®¡ç®—ä¸ç§æœ‰æœåŠ¡å™¨ã€‚

---

## ğŸ“‹ ç›®å½•

- [æ–¹æ¡ˆä¸€ï¼šCloudflare Workersï¼ˆæç®€éƒ¨ç½²ï¼‰](#æ–¹æ¡ˆä¸€cloudflare-workersæç®€éƒ¨ç½²)
- [æ–¹æ¡ˆäºŒï¼šç§æœ‰ VPS / Node.js éƒ¨ç½²ï¼ˆç‹¬ç«‹æŒæ§ï¼‰](#æ–¹æ¡ˆäºŒç§æœ‰-vps--nodejs-éƒ¨ç½²ç‹¬ç«‹æŒæ§)
- [éƒ¨ç½²å¯¹æ¯”](#éƒ¨ç½²å¯¹æ¯”)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## æ–¹æ¡ˆä¸€ï¼šCloudflare Workersï¼ˆæç®€éƒ¨ç½²ï¼‰

### æ¶æ„
```
Cloudflare Workers (å…¨çƒè¾¹ç¼˜èŠ‚ç‚¹)
    â†“
Cloudflare D1 Database (è¾¹ç¼˜ SQLite)
```

### éƒ¨ç½²æ­¥éª¤

1. **å‡†å¤‡ç¯å¢ƒ**
   ```bash
   npm install
   wrangler login
   ```

2. **åˆ›å»ºä¸åˆå§‹åŒ–æ•°æ®åº“**
   ```bash
   npx wrangler d1 create hw-db
   # å°†è¾“å‡ºçš„ database_id å¡«å…¥ wrangler.toml
   npx wrangler d1 execute hw-db --remote --file=./schema.sql
   ```

3. **é…ç½®å¯†é’¥**
   ```bash
   npx wrangler secret put ADMIN_SECRET
   npx wrangler secret put JWT_SECRET
   ```

4. **ä¸€é”®å‘å°„**
   ```bash
   npx wrangler deploy
   ```

---

## æ–¹æ¡ˆäºŒï¼šç§æœ‰ VPS / Node.js éƒ¨ç½²ï¼ˆç‹¬ç«‹æŒæ§ï¼‰

### æ¶æ„ä¼˜åŠ¿
æœ¬é¡¹ç›®åº•å±‚é€šè¿‡ `DBAdapter` å±è”½äº†å­˜å‚¨å·®å¼‚ã€‚åœ¨ VPS ç¯å¢ƒä¸‹ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å¯ç”¨ **SQLite WAL (Write-Ahead Logging)** æ¨¡å¼ï¼Œå¹¶æ³¨å…¥é«˜æ€§èƒ½ PRAGMA é…ç½®ï¼ˆå¦‚ `Synchronous=NORMAL`ï¼‰ï¼Œç¡®ä¿å•æœºå¹¶å‘èƒ½åŠ›æœ€å¤§åŒ–ã€‚

### éƒ¨ç½²æ­¥éª¤

1. **ç¯å¢ƒå‡†å¤‡**
   ç¡®ä¿å·²å®‰è£… **Node.js 18+**ã€‚

2. **é¡¹ç›®åˆå§‹åŒ–**
   ```bash
   git clone <repo-url>
   cd hw-license-center
   npm install
   ```

3. **é…ç½®ç¯å¢ƒå˜é‡**
   åœ¨æ ¹ç›®å½•åˆ›å»º `.env` æ–‡ä»¶ï¼š
   ```env
   ADMIN_SECRET=ä½ çš„ç®¡ç†åå°å¯†é’¥
   JWT_SECRET=ä½ çš„è®¾å¤‡æ ¡éªŒå¯†é’¥
   PORT=3000
   ```

4. **åˆå§‹åŒ–æœ¬åœ°æ•°æ®åº“**
   ä½¿ç”¨å†…ç½®è„šæœ¬æˆ–æ‰‹åŠ¨åˆ›å»ºï¼š
   ```bash
   # ç¡®ä¿ç›®å½•å­˜åœ¨
   mkdir -p .wrangler/state/v3/d1/miniflare-D1DatabaseObject/
   # å†™å…¥è¡¨ç»“æ„
   sqlite3 .wrangler/state/v3/d1/miniflare-D1DatabaseObject/db.sqlite < schema.sql
   ```

5. **æ„å»ºå¹¶å¯åŠ¨ (æ¨èä½¿ç”¨ PM2)**
   ```bash
   # ç¼–è¯‘
   npm run build:node
   
   # å¯åŠ¨
   npm install -g pm2
   pm2 start dist/server.js --name "km-center"
   ```

---

## ğŸš€ éƒ¨ç½²å¯¹æ¯”

| ç»´åº¦ | Cloudflare Workers | ç§æœ‰ VPS (Node.js) |
|-----|-------------------|-------------------|
| **éƒ¨ç½²éš¾åº¦** | â­ æä½ | â­â­ ä¸­ç­‰ |
| **æ•°æ®åº“** | Cloudflare D1 (åˆ†å¸ƒ) | æœ¬åœ° SQLite (é«˜æ€§èƒ½ WAL) |
| **è´¹ç”¨** | å…è´¹é¢åº¦æé«˜ | éœ€æ”¯ä»˜æœåŠ¡å™¨æœˆè´¹ |
| **æ•°æ®æŒæ§** | æ‰˜ç®¡åœ¨ CF è¾¹ç¼˜ | 100% æ•°æ®è‡ªä¸»æ‰€æœ‰ |
| **æ‰©å±•æ€§** | è‡ªåŠ¨æ— é™å‚ç›´æ‰©å±• | å—é™äºå•æœºç¡¬ä»¶æ€§èƒ½ |

---

## ğŸ’¡ å¸¸è§é—®é¢˜

### Q: æ˜¯å¦éœ€è¦ç”±äºéƒ¨ç½²å¹³å°ä¸åŒè€Œä¿®æ”¹ä»£ç ï¼Ÿ
A: **ä¸éœ€è¦**ã€‚æœ¬é¡¹ç›®å·²å®Œæˆ `DBAdapter` çš„æŠ½è±¡é‡æ„ï¼Œç³»ç»Ÿå¯åŠ¨æ—¶ä¼šè‡ªåŠ¨è¯†åˆ«ç¯å¢ƒå¹¶æŒ‚è½½å¯¹åº”çš„æ•°æ®åº“é©±åŠ¨ã€‚

### Q: å¦‚ä½•è¿›è¡Œæ•°æ®è¿ç§»ï¼Ÿ
A: 
- **ä» CF åˆ° VPS**ï¼šæ‰§è¡Œ `npx wrangler d1 export <db> --remote --output=dump.sql`ï¼Œç„¶ååœ¨ VPS ä¸Šç”¨ `sqlite3` å¯¼å…¥ã€‚
- **ä» VPS åˆ° CF**ï¼šå°† `.db` æ–‡ä»¶è½¬æ¢ä¸º SQL åæ‰§è¡Œ `wrangler d1 execute`ã€‚

---

## æ€»ç»“
- **è¿½æ±‚æè‡´ç®€å•ä¸å…è¿ç»´**ï¼šé€‰ Cloudflare Workersã€‚
- **è¿½æ±‚æ•°æ®ç»å¯¹ç§å¯†æˆ–å›½å†…è®¿é—®æé€Ÿ**ï¼šé€‰ç§æœ‰ VPSã€‚
